<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyMessage - Новый мессенджер</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Все стили остаются те же */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #7209b7;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --border-color: #e0e0e0;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background-color: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            display: flex;
            transition: var(--transition);
        }

        .auth-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .auth-form {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background-color: white;
        }

        .auth-illustration {
            flex: 1;
            background: linear-gradient(to bottom right, var(--primary-color), var(--secondary-color));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: white;
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-size: 1.8rem;
        }

        .logo-text {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .form-subtitle {
            color: var(--gray-color);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            padding: 14px 20px;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--light-color);
            color: var(--dark-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: #e9ecef;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .toggle-form {
            text-align: center;
            margin-top: 20px;
            color: var(--gray-color);
        }

        .toggle-form a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .error-message {
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }

        .main-container {
            display: none;
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 350px;
            background-color: #f8f9fa;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .user-info {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            background-color: white;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            margin-right: 15px;
        }

        .user-details h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .user-details p {
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        .search-container {
            padding: 20px;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 0.95rem;
            background-color: #f8f9fa;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .contacts-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .contact {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 5px;
        }

        .contact:hover {
            background-color: #e9ecef;
        }

        .contact.active {
            background-color: #e3f2fd;
        }

        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 15px;
        }

        .contact-info h4 {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .contact-info p {
            color: var(--gray-color);
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .contact-status {
            margin-left: auto;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .contact-status.online {
            background-color: #4caf50;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: white;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
        }

        .chat-header-buttons {
            display: flex;
            gap: 10px;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 15px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message-outgoing {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message-incoming {
            align-self: flex-start;
            background-color: white;
            color: var(--dark-color);
            border-bottom-left-radius: 5px;
            border: 1px solid var(--border-color);
        }

        .message-time {
            font-size: 0.75rem;
            margin-top: 5px;
            opacity: 0.8;
            text-align: right;
        }

        .message-input-container {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            background-color: white;
        }

        .message-input {
            flex: 1;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            resize: none;
            max-height: 100px;
        }

        .send-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .send-button:hover {
            background-color: var(--primary-dark);
            transform: scale(1.05);
        }

        .call-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .call-info {
            text-align: center;
            margin-bottom: 40px;
        }

        .call-info h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .call-info p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .video-container {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            max-width: 1200px;
            width: 90%;
        }

        .video-box {
            flex: 1;
            border-radius: 10px;
            overflow: hidden;
            background-color: #333;
            position: relative;
            aspect-ratio: 16/9;
        }

        .video-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .call-controls {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .call-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            border: none;
        }

        .call-button.accept {
            background-color: #4caf50;
            color: white;
        }

        .call-button.decline {
            background-color: #f44336;
            color: white;
        }

        .call-button.end {
            background-color: #f44336;
            color: white;
        }

        .call-button.toggle {
            background-color: #2196f3;
            color: white;
        }

        .call-button.toggle.active {
            background-color: #f44336;
        }

        .call-button:hover {
            transform: scale(1.1);
        }

        .device-selectors {
            margin-top: 20px;
            display: flex;
            gap: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .device-selector {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .device-selector select {
            padding: 8px 12px;
            border-radius: 5px;
            background-color: #333;
            color: white;
            border: none;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: white;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 100;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .notification.incoming-call .notification-icon {
            background-color: var(--primary-color);
        }

        .notification.message .notification-icon {
            background-color: var(--success-color);
        }

        .notification-content h4 {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .notification-content p {
            font-size: 0.9rem;
            color: var(--gray-color);
        }

        .notification-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                height: 95vh;
                border-radius: 10px;
            }
            
            .auth-container {
                flex-direction: column;
            }
            
            .auth-illustration {
                padding: 20px;
                order: -1;
            }
            
            .auth-illustration h2 {
                font-size: 1.8rem;
            }
            
            .auth-form {
                padding: 30px 20px;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .video-container {
                flex-direction: column;
                width: 95%;
            }
            
            .call-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .device-selectors {
                flex-direction: column;
                width: 90%;
            }
            
            .message {
                max-width: 85%;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .hidden {
            display: none !important;
        }

        .visible {
            display: flex;
        }
        
        .api-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            z-index: 1000;
            background-color: rgba(0,0,0,0.7);
            color: white;
        }
        
        .api-status.online {
            background-color: rgba(76, 175, 80, 0.8);
        }
        
        .api-status.offline {
            background-color: rgba(244, 67, 54, 0.8);
        }
        
        .api-controls {
            position: fixed;
            top: 40px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 1000;
        }
        
        .api-controls button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .api-controls button:hover {
            background-color: rgba(67, 97, 238, 0.8);
        }
        
        .api-debug {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            max-width: 300px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .api-debug.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="api-status" id="apiStatus">API: Проверка...</div>
    <div class="api-controls" id="apiControls">
        <button id="refreshApiBtn">Обновить</button>
        <button id="toggleDebugBtn">Отладка</button>
    </div>
    <div class="api-debug" id="apiDebug"></div>
    
    <div class="container" id="appContainer">
        <div class="auth-container" id="authContainer">
            <div class="auth-form">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="logo-text">SkyMessage</div>
                </div>
                
                <h2 class="form-title" id="formTitle">Войдите в аккаунт</h2>
                <p class="form-subtitle" id="formSubtitle">Введите свои данные для входа в мессенджер</p>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="loginUsername">Имя пользователя</label>
                        <input type="text" class="form-input" id="loginUsername" placeholder="Введите ваш никнейм" required>
                        <div class="error-message" id="loginUsernameError">Пользователь не найден</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Пароль</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Введите ваш пароль" required>
                        <div class="error-message" id="loginPasswordError">Неверный пароль</div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="loginButton">
                        <i class="fas fa-sign-in-alt"></i> Войти
                    </button>
                </form>
                
                <form id="registerForm" class="hidden">
                    <div class="form-group">
                        <label class="form-label" for="registerUsername">Имя пользователя</label>
                        <input type="text" class="form-input" id="registerUsername" placeholder="Придумайте уникальный никнейм" required minlength="3">
                        <div class="error-message" id="registerUsernameError">Этот никнейм уже занят</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="registerPassword">Пароль</label>
                        <input type="password" class="form-input" id="registerPassword" placeholder="Придумайте надежный пароль" required minlength="6">
                        <div class="error-message" id="registerPasswordError">Пароль должен содержать минимум 6 символов</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="registerConfirmPassword">Подтверждение пароля</label>
                        <input type="password" class="form-input" id="registerConfirmPassword" placeholder="Повторите пароль" required>
                        <div class="error-message" id="registerConfirmPasswordError">Пароли не совпадают</div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="registerButton">
                        <i class="fas fa-user-plus"></i> Зарегистрироваться
                    </button>
                </form>
                
                <div class="toggle-form">
                    <span id="toggleText">Нет аккаунта?</span>
                    <a id="toggleLink">Зарегистрироваться</a>
                </div>
            </div>
            
            <div class="auth-illustration">
                <h2>SkyMessage</h2>
                <p>Новый способ общения. Отправляйте сообщения, совершайте видеозвонки и оставайтесь на связи с близкими в любое время и в любом месте.</p>
                <div style="margin-top: 40px; font-size: 5rem; opacity: 0.8;">
                    <i class="fas fa-comment-dots"></i>
                </div>
            </div>
        </div>
        
        <div class="main-container" id="mainContainer">
            <div class="sidebar">
                <div class="user-info">
                    <div class="user-avatar" id="currentUserAvatar">U</div>
                    <div class="user-details">
                        <h3 id="currentUserName">Пользователь</h3>
                        <p id="currentUserStatus">online</p>
                    </div>
                    <button class="btn btn-secondary btn-small" id="logoutButton" style="margin-left: auto;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
                
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchUser" placeholder="Найти пользователя по никнейму">
                        <div class="error-message" id="searchError" style="margin-top: 5px; display: none;"></div>
                    </div>
                </div>
                
                <div class="contacts-container" id="contactsContainer">
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-header" id="chatHeader">
                    <div class="chat-user-info">
                        <div class="contact-avatar" id="chatUserAvatar">U</div>
                        <div>
                            <h3 id="chatUserName">Выберите чат</h3>
                            <p id="chatUserStatus">начните общение</p>
                        </div>
                    </div>
                    
                    <div class="chat-header-buttons">
                        <button class="btn btn-secondary btn-small" id="voiceCallButton" disabled>
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="btn btn-secondary btn-small" id="videoCallButton" disabled>
                            <i class="fas fa-video"></i>
                        </button>
                    </div>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <div style="text-align: center; margin-top: 50px; color: var(--gray-color);">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Выберите чат для начала общения</p>
                    </div>
                </div>
                
                <div class="message-input-container">
                    <textarea class="message-input" id="messageInput" placeholder="Введите сообщение..." rows="1" disabled></textarea>
                    <button class="send-button" id="sendMessageButton" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="call-container" id="callContainer">
        <div class="call-info">
            <h2 id="callTitle">Входящий видеозвонок</h2>
            <p id="callDescription">Пользователь звонит вам</p>
        </div>
        
        <div class="video-container">
            <div class="video-box">
                <video id="localVideo" autoplay muted></video>
                <div class="video-label">Вы</div>
            </div>
            
            <div class="video-box">
                <video id="remoteVideo" autoplay></video>
                <div class="video-label" id="remoteUserName">Собеседник</div>
            </div>
        </div>
        
        <div class="call-controls">
            <button class="call-button accept" id="acceptCallButton">
                <i class="fas fa-phone"></i>
            </button>
            <button class="call-button decline" id="declineCallButton">
                <i class="fas fa-phone-slash"></i>
            </button>
            <button class="call-button toggle" id="toggleVideoButton">
                <i class="fas fa-video"></i>
            </button>
            <button class="call-button toggle" id="toggleAudioButton">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="call-button end hidden" id="endCallButton">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
        
        <div class="device-selectors">
            <div class="device-selector">
                <label for="cameraSelect">Камера:</label>
                <select id="cameraSelect"></select>
            </div>
            <div class="device-selector">
                <label for="microphoneSelect">Микрофон:</label>
                <select id="microphoneSelect"></select>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <div class="notification-icon">
            <i class="fas fa-bell"></i>
        </div>
        <div class="notification-content">
            <h4 id="notificationTitle">Уведомление</h4>
            <p id="notificationText">Текст уведомления</p>
            <div class="notification-actions" id="notificationActions"></div>
        </div>
    </div>

    <script>
        // ===== КОНФИГУРАЦИЯ JSONBIN.IO =====
        // ЗАМЕНИТЕ ЭТИ ЗНАЧЕНИЯ НА СВОИ!
        const JSONBIN_CONFIG = {
            // Ваш BIN ID (последняя часть URL из jsonbin.io)
            BIN_ID: '6987a97443b1c97be96d38ce',
            
            // Ваш Master Key (можно найти в Dashboard)
            MASTER_KEY: '$2a$10$I2I96lPMR/JKjetj1oc93eTQG.dkoeYEtV1j88hu5qFK8D0yAq6k2',
            
            // Или Access Key (если есть)
            ACCESS_KEY: null,
            
            // Версия API
            API_VERSION: 'v3',
            
            // Базовый URL
            BASE_URL: 'https://api.jsonbin.io',
            
            // Получение заголовков
            getHeaders: function() {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // Используем Master Key если есть
                if (this.MASTER_KEY) {
                    headers['X-Master-Key'] = this.MASTER_KEY;
                }
                
                // Или Access Key
                if (this.ACCESS_KEY) {
                    headers['X-Access-Key'] = this.ACCESS_KEY;
                }
                
                return headers;
            },
            
            // Получение URL для операций
            getUrl: function(operation = 'read', version = 'latest') {
                if (operation === 'create') {
                    return `${this.BASE_URL}/${this.API_VERSION}/b`;
                } else if (operation === 'update') {
                    return `${this.BASE_URL}/${this.API_VERSION}/b/${this.BIN_ID}`;
                } else {
                    return `${this.BASE_URL}/${this.API_VERSION}/b/${this.BIN_ID}/${version}`;
                }
            },
            
            // Проверка конфигурации
            isValid: function() {
                return this.BIN_ID && this.BIN_ID !== 'YOUR_BIN_ID_HERE' && 
                       (this.MASTER_KEY || this.ACCESS_KEY);
            }
        };
        
        // ===== ГЛОБАЛЬНАЯ БАЗА ДАННЫХ (JSONBIN.IO) =====
        const GlobalDatabase = {
            // Кэшированные данные
            cache: {
                users: [],
                onlineUsers: {},
                lastFetch: 0,
                cacheDuration: 10000 // 10 секунд кэш
            },
            
            // Статус соединения
            isOnline: false,
            lastError: null,
            debugLog: [],
            
            // Добавление в лог отладки
            addDebugLog: function(message, type = 'info') {
                const logEntry = {
                    timestamp: new Date().toLocaleTimeString(),
                    message: message,
                    type: type
                };
                this.debugLog.unshift(logEntry);
                if (this.debugLog.length > 20) this.debugLog.pop();
                this.updateDebugDisplay();
            },
            
            // Обновление отладочного дисплея
            updateDebugDisplay: function() {
                const debugElement = document.getElementById('apiDebug');
                if (debugElement) {
                    debugElement.innerHTML = this.debugLog.map(log => 
                        `<div style="color: ${log.type === 'error' ? '#ff6b6b' : log.type === 'success' ? '#51cf66' : '#ffffff'}">
                            [${log.timestamp}] ${log.message}
                        </div>`
                    ).join('');
                }
            },
            
            // Инициализация
            init: async function() {
                this.addDebugLog('Инициализация GlobalDatabase...');
                
                // Проверяем конфигурацию
                if (!JSONBIN_CONFIG.isValid()) {
                    this.addDebugLog('ОШИБКА: Конфигурация JSONBin не настроена!', 'error');
                    this.addDebugLog('Пожалуйста, замените BIN_ID и MASTER_KEY в JSONBIN_CONFIG', 'error');
                    this.isOnline = false;
                    this.updateApiStatus(false, 'Не настроен');
                    await this.loadFromLocalStorage();
                } else {
                    this.isOnline = await this.checkConnection();
                    
                    if (this.isOnline) {
                        this.addDebugLog('JSONBin.io доступен, загружаем данные...', 'success');
                        await this.loadFromJsonBin();
                        this.updateApiStatus(true, 'JSONBin.io');
                    } else {
                        this.addDebugLog('JSONBin.io недоступен, используем локальные данные...', 'warning');
                        await this.loadFromLocalStorage();
                        this.updateApiStatus(false, 'Локально');
                    }
                }
                
                // Если база пуста, создаем демо-пользователей
                if (this.isEmpty()) {
                    this.addDebugLog('База данных пуста, создаем демо-пользователей...', 'info');
                    this.createDemoUsers();
                    await this.save();
                }
                
                this.addDebugLog(`GlobalDatabase инициализирована. Пользователей: ${this.getUsersCount()}`, 'success');
            },
            
            // Проверка соединения с JSONBin
            checkConnection: async function() {
                try {
                    this.addDebugLog('Проверка соединения с JSONBin.io...', 'info');
                    const url = JSONBIN_CONFIG.getUrl('read');
                    const headers = JSONBIN_CONFIG.getHeaders();
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: headers
                    });
                    
                    const result = response.ok;
                    this.addDebugLog(`Соединение с JSONBin.io: ${result ? 'OK' : 'FAIL'} (${response.status})`, 
                                   result ? 'success' : 'error');
                    
                    if (!response.ok) {
                        this.lastError = `HTTP ${response.status}: ${response.statusText}`;
                        const errorData = await response.text();
                        this.addDebugLog(`Ошибка ответа: ${errorData.substring(0, 100)}`, 'error');
                    }
                    
                    return result;
                } catch (error) {
                    this.lastError = error.message;
                    this.addDebugLog(`Ошибка соединения: ${error.message}`, 'error');
                    return false;
                }
            },
            
            // Загрузка из JSONBin
            loadFromJsonBin: async function() {
                try {
                    const url = JSONBIN_CONFIG.getUrl('read');
                    const headers = JSONBIN_CONFIG.getHeaders();
                    
                    this.addDebugLog('Загрузка данных с JSONBin.io...', 'info');
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: headers
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // JSONBin возвращает данные в поле "record"
                        const dbData = data.record || data;
                        
                        this.cache.users = dbData.users || [];
                        this.cache.onlineUsers = dbData.onlineUsers || {};
                        this.cache.lastFetch = Date.now();
                        
                        // Сохраняем локальную копию
                        this.saveToLocalStorage();
                        
                        this.addDebugLog(`Загружено ${this.cache.users.length} пользователей`, 'success');
                        return true;
                    } else {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    this.lastError = error.message;
                    this.addDebugLog(`Ошибка загрузки: ${error.message}`, 'error');
                    return await this.loadFromLocalStorage();
                }
            },
            
            // Загрузка из localStorage
            loadFromLocalStorage: function() {
                try {
                    const data = localStorage.getItem('skyMessageJsonBinBackup');
                    if (data) {
                        const parsed = JSON.parse(data);
                        this.cache.users = parsed.users || [];
                        this.cache.onlineUsers = parsed.onlineUsers || {};
                        this.cache.lastFetch = Date.now();
                        this.addDebugLog(`Загружено ${this.cache.users.length} пользователей из localStorage`, 'info');
                        return true;
                    }
                } catch (e) {
                    this.addDebugLog(`Ошибка загрузки из localStorage: ${e.message}`, 'error');
                }
                
                this.cache.users = [];
                this.cache.onlineUsers = {};
                this.addDebugLog('Локальные данные не найдены', 'warning');
                return false;
            },
            
            // Сохранение в localStorage
            saveToLocalStorage: function() {
                try {
                    const data = {
                        users: this.cache.users,
                        onlineUsers: this.cache.onlineUsers,
                        lastUpdate: Date.now()
                    };
                    localStorage.setItem('skyMessageJsonBinBackup', JSON.stringify(data));
                } catch (e) {
                    this.addDebugLog(`Ошибка сохранения в localStorage: ${e.message}`, 'error');
                }
            },
            
            // Сохранение в JSONBin
            saveToJsonBin: async function() {
                if (!this.isOnline) {
                    this.addDebugLog('Офлайн режим, сохраняем только локально', 'warning');
                    this.saveToLocalStorage();
                    return false;
                }
                
                try {
                    const data = {
                        users: this.cache.users,
                        onlineUsers: this.cache.onlineUsers,
                        lastUpdate: Date.now(),
                        metadata: {
                            app: 'SkyMessage',
                            version: '1.0',
                            totalUsers: this.cache.users.length
                        }
                    };
                    
                    const url = JSONBIN_CONFIG.getUrl('update');
                    const headers = JSONBIN_CONFIG.getHeaders();
                    
                    this.addDebugLog('Сохранение данных на JSONBin.io...', 'info');
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: headers,
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.addDebugLog(`Успешно сохранено. Версия: ${result.version || 'N/A'}`, 'success');
                        return true;
                    } else {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    this.lastError = error.message;
                    this.addDebugLog(`Ошибка сохранения: ${error.message}`, 'error');
                    this.saveToLocalStorage();
                    return false;
                }
            },
            
            // Общий метод сохранения
            save: async function() {
                this.addDebugLog('Сохранение данных...', 'info');
                const savedOnline = await this.saveToJsonBin();
                if (!savedOnline) {
                    this.saveToLocalStorage();
                }
            },
            
            // Обновление статуса API
            updateApiStatus: function(isOnline, mode = '') {
                this.isOnline = isOnline;
                const statusElement = document.getElementById('apiStatus');
                if (statusElement) {
                    const statusText = isOnline ? `API: Онлайн (${mode})` : `API: Офлайн (${mode})`;
                    statusElement.textContent = statusText;
                    statusElement.className = isOnline ? 'api-status online' : 'api-status offline';
                    
                    if (this.lastError) {
                        statusElement.title = `Последняя ошибка: ${this.lastError}`;
                    }
                }
            },
            
            // Проверка на пустоту
            isEmpty: function() {
                return this.cache.users.length === 0;
            },
            
            // Создание демо-пользователей
            createDemoUsers: function() {
                const demoUsers = [
                    {
                        id: 'demo1',
                        username: "alex_sky",
                        name: "Александр",
                        avatar: "А",
                        password: "password123",
                        status: "online",
                        lastSeen: "только что",
                        online: true,
                        registered: Date.now() - 86400000,
                        email: "alex@example.com"
                    },
                    {
                        id: 'demo2',
                        username: "maria_chat",
                        name: "Мария",
                        avatar: "М",
                        password: "password123",
                        status: "online",
                        lastSeen: "5 минут назад",
                        online: true,
                        registered: Date.now() - 172800000,
                        email: "maria@example.com"
                    },
                    {
                        id: 'demo3',
                        username: "max_talk",
                        name: "Максим",
                        avatar: "М",
                        password: "password123",
                        status: "offline",
                        lastSeen: "2 часа назад",
                        online: false,
                        registered: Date.now() - 259200000,
                        email: "max@example.com"
                    },
                    {
                        id: 'demo4',
                        username: "anna_web",
                        name: "Анна",
                        avatar: "А",
                        password: "password123",
                        status: "online",
                        lastSeen: "в сети",
                        online: true,
                        registered: Date.now() - 345600000,
                        email: "anna@example.com"
                    },
                    {
                        id: 'demo5',
                        username: "dmitry_conn",
                        name: "Дмитрий",
                        avatar: "Д",
                        password: "password123",
                        status: "offline",
                        lastSeen: "вчера",
                        online: false,
                        registered: Date.now() - 432000000,
                        email: "dmitry@example.com"
                    }
                ];
                
                this.cache.users = demoUsers;
                this.addDebugLog(`Создано ${demoUsers.length} демо-пользователей`, 'success');
            },
            
            // Получение количества пользователей
            getUsersCount: function() {
                return this.cache.users.length;
            },
            
            // Поиск пользователя по username
            findUserByUsername: function(username) {
                return this.cache.users.find(user => user.username === username);
            },
            
            // Проверка существования пользователя
            userExists: function(username) {
                return this.cache.users.some(user => user.username === username);
            },
            
            // Добавление нового пользователя
            addUser: async function(user) {
                // Проверяем, нет ли уже такого пользователя
                if (this.userExists(user.username)) {
                    this.addDebugLog(`Пользователь ${user.username} уже существует`, 'warning');
                    return false;
                }
                
                this.cache.users.push(user);
                await this.save();
                this.addDebugLog(`Добавлен новый пользователь: ${user.username}`, 'success');
                return true;
            },
            
            // Поиск пользователей (исключая текущего)
            searchUsers: function(query, excludeUserId) {
                // Проверяем, не устарел ли кэш (только если онлайн)
                if (this.isOnline && Date.now() - this.cache.lastFetch > this.cache.cacheDuration) {
                    // В фоне обновляем данные
                    this.loadFromJsonBin().then(updated => {
                        if (updated) {
                            this.addDebugLog('Данные обновлены из JSONBin.io', 'info');
                        }
                    });
                }
                
                const searchQuery = query.toLowerCase().trim();
                if (!searchQuery) return [];
                
                return this.cache.users.filter(user => {
                    // Пропускаем текущего пользователя
                    if (excludeUserId && user.id === excludeUserId) return false;
                    
                    // Ищем по username и name
                    return user.username.toLowerCase().includes(searchQuery) ||
                           user.name.toLowerCase().includes(searchQuery) ||
                           (user.email && user.email.toLowerCase().includes(searchQuery));
                });
            },
            
            // Получение всех пользователей кроме указанного
            getAllUsersExcept: function(excludeUserId) {
                if (!excludeUserId) return this.cache.users;
                return this.cache.users.filter(user => user.id !== excludeUserId);
            },
            
            // Обновление статуса пользователя
            updateUserStatus: async function(userId, isOnline) {
                const user = this.cache.users.find(u => u.id === userId);
                if (user) {
                    user.online = isOnline;
                    user.status = isOnline ? 'online' : 'offline';
                    user.lastSeen = isOnline ? 'только что' : user.lastSeen;
                    user.lastSeenTimestamp = Date.now();
                    
                    if (isOnline) {
                        this.cache.onlineUsers[userId] = Date.now();
                    } else {
                        delete this.cache.onlineUsers[userId];
                    }
                    
                    await this.save();
                    this.addDebugLog(`Статус пользователя ${user.username} обновлен: ${isOnline ? 'online' : 'offline'}`, 'info');
                }
            },
            
            // Обновление случайных статусов (для демо)
            updateRandomStatuses: async function() {
                let changed = false;
                
                this.cache.users.forEach(user => {
                    if (user.id.startsWith('demo')) {
                        // 5% вероятность смены статуса
                        if (Math.random() < 0.05) {
                            user.online = !user.online;
                            user.status = user.online ? 'online' : 'offline';
                            user.lastSeen = user.online ? 'только что' : this.getRandomLastSeen();
                            changed = true;
                        }
                    }
                });
                
                if (changed) {
                    await this.save();
                    this.addDebugLog('Статусы демо-пользователей обновлены', 'info');
                }
            },
            
            getRandomLastSeen: function() {
                const times = [
                    'только что',
                    '5 минут назад',
                    '10 минут назад',
                    '30 минут назад',
                    'час назад',
                    '2 часа назад',
                    'сегодня',
                    'вчера',
                    'недавно'
                ];
                return times[Math.floor(Math.random() * times.length)];
            },
            
            // Синхронизация с сервером
            syncWithServer: async function() {
                if (!this.isOnline) {
                    this.addDebugLog('Офлайн режим, синхронизация невозможна', 'warning');
                    return false;
                }
                
                try {
                    this.addDebugLog('Синхронизация с JSONBin.io...', 'info');
                    const success = await this.loadFromJsonBin();
                    if (success) {
                        this.addDebugLog('Синхронизация успешна', 'success');
                    } else {
                        this.addDebugLog('Синхронизация не удалась', 'error');
                    }
                    return success;
                } catch (error) {
                    this.addDebugLog(`Ошибка синхронизации: ${error.message}`, 'error');
                    return false;
                }
            },
            
            // Проверка конфигурации
            checkConfig: function() {
                const configStatus = {
                    binId: JSONBIN_CONFIG.BIN_ID,
                    hasMasterKey: !!JSONBIN_CONFIG.MASTER_KEY,
                    hasAccessKey: !!JSONBIN_CONFIG.ACCESS_KEY,
                    isConfigured: JSONBIN_CONFIG.isValid()
                };
                
                this.addDebugLog(`Конфигурация: BIN_ID=${configStatus.binId}, MASTER_KEY=${configStatus.hasMasterKey}, Configured=${configStatus.isConfigured}`, 'info');
                return configStatus;
            }
        };
        
        // ===== ЛОКАЛЬНЫЕ ДАННЫЕ ПОЛЬЗОВАТЕЛЯ (в localStorage) =====
        const UserData = {
            // Текущий пользователь
            currentUser: null,
            
            // Контакты пользователя
            contacts: [],
            
            // Сообщения пользователя
            messages: {},
            
            // Инициализация
            init: function() {
                GlobalDatabase.addDebugLog('Инициализация UserData...', 'info');
                this.loadCurrentUser();
                
                if (this.currentUser) {
                    this.loadContacts();
                    this.loadMessages();
                }
            },
            
            // Загрузка текущего пользователя
            loadCurrentUser: function() {
                try {
                    const userData = localStorage.getItem('skyMessageCurrentUser');
                    if (userData) {
                        this.currentUser = JSON.parse(userData);
                        GlobalDatabase.addDebugLog(`Загружен текущий пользователь: ${this.currentUser.username}`, 'success');
                    }
                } catch (e) {
                    GlobalDatabase.addDebugLog(`Ошибка загрузки текущего пользователя: ${e.message}`, 'error');
                    this.currentUser = null;
                }
            },
            
            // Сохранение текущего пользователя
            saveCurrentUser: function() {
                if (this.currentUser) {
                    localStorage.setItem('skyMessageCurrentUser', JSON.stringify(this.currentUser));
                }
            },
            
            // Загрузка контактов
            loadContacts: function() {
                try {
                    const contactsData = localStorage.getItem(`skyMessageContacts_${this.currentUser.username}`);
                    if (contactsData) {
                        this.contacts = JSON.parse(contactsData);
                        GlobalDatabase.addDebugLog(`Загружено контактов: ${this.contacts.length}`, 'info');
                    }
                } catch (e) {
                    GlobalDatabase.addDebugLog(`Ошибка загрузки контактов: ${e.message}`, 'error');
                    this.contacts = [];
                }
            },
            
            // Сохранение контактов
            saveContacts: function() {
                localStorage.setItem(`skyMessageContacts_${this.currentUser.username}`, JSON.stringify(this.contacts));
            },
            
            // Загрузка сообщений
            loadMessages: function() {
                try {
                    const messagesData = localStorage.getItem(`skyMessageMessages_${this.currentUser.username}`);
                    if (messagesData) {
                        this.messages = JSON.parse(messagesData);
                        GlobalDatabase.addDebugLog(`Загружено чатов: ${Object.keys(this.messages).length}`, 'info');
                    }
                } catch (e) {
                    GlobalDatabase.addDebugLog(`Ошибка загрузки сообщений: ${e.message}`, 'error');
                    this.messages = {};
                }
            },
            
            // Сохранение сообщений
            saveMessages: function() {
                localStorage.setItem(`skyMessageMessages_${this.currentUser.username}`, JSON.stringify(this.messages));
            },
            
            // Создание начальных контактов
            createInitialContacts: function() {
                // Берем первых 3 пользователя из глобальной базы
                const allUsers = GlobalDatabase.getAllUsersExcept(this.currentUser.id);
                const initialContacts = allUsers.slice(0, 3).map(user => ({
                    id: user.id,
                    username: user.username,
                    name: user.name,
                    avatar: user.avatar,
                    status: user.online ? 'online' : 'offline',
                    lastSeen: user.lastSeen,
                    online: user.online,
                    email: user.email
                }));
                
                this.contacts = initialContacts;
                this.saveContacts();
                
                // Создаем начальные сообщения
                initialContacts.forEach(contact => {
                    if (!this.messages[contact.id]) {
                        this.messages[contact.id] = [
                            {
                                id: Date.now(),
                                text: `Привет! Я ${contact.name}. Рад познакомиться!`,
                                sender: contact.id,
                                time: this.getCurrentTime(),
                                outgoing: false,
                                timestamp: Date.now()
                            },
                            {
                                id: Date.now() + 1,
                                text: `Привет, ${contact.name}! Очень приятно!`,
                                sender: this.currentUser.id,
                                time: this.getCurrentTime(),
                                outgoing: true,
                                timestamp: Date.now() + 1
                            }
                        ];
                    }
                });
                
                this.saveMessages();
                
                GlobalDatabase.addDebugLog(`Созданы начальные контакты: ${initialContacts.length}`, 'success');
            },
            
            // Получение текущего времени
            getCurrentTime: function() {
                const now = new Date();
                return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            },
            
            // Добавление контакта
            addContact: function(user) {
                // Проверяем, не добавлен ли уже
                if (this.contacts.some(contact => contact.id === user.id)) {
                    return false;
                }
                
                const contactToAdd = {
                    id: user.id,
                    username: user.username,
                    name: user.name,
                    avatar: user.avatar,
                    status: user.online ? 'online' : 'offline',
                    lastSeen: user.lastSeen,
                    online: user.online,
                    email: user.email
                };
                
                this.contacts.push(contactToAdd);
                this.saveContacts();
                
                // Создаем начальные сообщения для нового контакта
                if (!this.messages[user.id]) {
                    this.messages[user.id] = [
                        {
                            id: Date.now(),
                            text: `Привет! Я ${user.name}. Рад познакомиться!`,
                            sender: user.id,
                            time: this.getCurrentTime(),
                            outgoing: false,
                            timestamp: Date.now()
                        },
                        {
                            id: Date.now() + 1,
                            text: `Привет, ${user.name}! Очень приятно!`,
                            sender: this.currentUser.id,
                            time: this.getCurrentTime(),
                            outgoing: true,
                            timestamp: Date.now() + 1
                        }
                    ];
                    this.saveMessages();
                }
                
                GlobalDatabase.addDebugLog(`Контакт добавлен: ${user.name}`, 'success');
                return contactToAdd;
            },
            
            // Добавление сообщения
            addMessage: function(contactId, message) {
                if (!this.messages[contactId]) {
                    this.messages[contactId] = [];
                }
                
                this.messages[contactId].push(message);
                this.saveMessages();
            },
            
            // Получение сообщений контакта
            getMessages: function(contactId) {
                return this.messages[contactId] || [];
            },
            
            // Очистка данных
            clear: function() {
                this.currentUser = null;
                this.contacts = [];
                this.messages = {};
                localStorage.removeItem('skyMessageCurrentUser');
                GlobalDatabase.addDebugLog('Данные пользователя очищены', 'info');
            }
        };
        
        // ===== ОСНОВНОЙ КОД ПРИЛОЖЕНИЯ =====
        document.addEventListener('DOMContentLoaded', async function() {
            // Инициализируем базы данных
            await GlobalDatabase.init();
            UserData.init();
            
            // Элементы интерфейса
            const appContainer = document.getElementById('appContainer');
            const authContainer = document.getElementById('authContainer');
            const mainContainer = document.getElementById('mainContainer');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const toggleLink = document.getElementById('toggleLink');
            const logoutButton = document.getElementById('logoutButton');
            const searchUserInput = document.getElementById('searchUser');
            const contactsContainer = document.getElementById('contactsContainer');
            const chatHeader = document.getElementById('chatHeader');
            const messagesContainer = document.getElementById('messagesContainer');
            const messageInput = document.getElementById('messageInput');
            const sendMessageButton = document.getElementById('sendMessageButton');
            const notification = document.getElementById('notification');
            
            // Переменные состояния
            let currentContact = null;
            let refreshInterval = null;
            
            // Проверяем авторизацию
            if (UserData.currentUser) {
                showMainInterface();
            } else {
                showAuthInterface();
            }
            
            // Настройка обработчиков событий
            setupEventListeners();
            
            function setupEventListeners() {
                // Переключение между формой входа и регистрации
                toggleLink.addEventListener('click', toggleAuthForm);
                
                // Форма входа
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    loginUser();
                });
                
                // Форма регистрации
                registerForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    registerUser();
                });
                
                // Выход из системы
                logoutButton.addEventListener('click', logoutUser);
                
                // Поиск пользователей
                searchUserInput.addEventListener('input', function() {
                    searchUsers(this.value);
                });
                
                // Отправка сообщения
                sendMessageButton.addEventListener('click', sendMessage);
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
                
                // Кнопки управления API
                document.getElementById('refreshApiBtn').addEventListener('click', async function() {
                    GlobalDatabase.addDebugLog('Принудительное обновление API...', 'info');
                    const wasOnline = GlobalDatabase.isOnline;
                    GlobalDatabase.isOnline = await GlobalDatabase.checkConnection();
                    
                    if (GlobalDatabase.isOnline && !wasOnline) {
                        await GlobalDatabase.loadFromJsonBin();
                    }
                    
                    GlobalDatabase.updateApiStatus(GlobalDatabase.isOnline, GlobalDatabase.isOnline ? 'JSONBin.io' : 'Локально');
                    
                    if (UserData.currentUser) {
                        renderContacts();
                    }
                });
                
                document.getElementById('toggleDebugBtn').addEventListener('click', function() {
                    const debugElement = document.getElementById('apiDebug');
                    debugElement.classList.toggle('visible');
                });
            }
            
            function toggleAuthForm() {
                const isLoginVisible = !loginForm.classList.contains('hidden');
                
                if (isLoginVisible) {
                    loginForm.classList.add('hidden');
                    registerForm.classList.remove('hidden');
                    document.getElementById('formTitle').textContent = 'Создайте аккаунт';
                    document.getElementById('formSubtitle').textContent = 'Зарегистрируйтесь, чтобы начать пользоваться мессенджером';
                    document.getElementById('toggleText').textContent = 'Уже есть аккаунт?';
                    toggleLink.textContent = 'Войти';
                } else {
                    registerForm.classList.remove('hidden');
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                    document.getElementById('formTitle').textContent = 'Войдите в аккаунт';
                    document.getElementById('formSubtitle').textContent = 'Введите свои данные для входа в мессенджер';
                    document.getElementById('toggleText').textContent = 'Нет аккаунта?';
                    toggleLink.textContent = 'Зарегистрироваться';
                }
                
                document.querySelectorAll('.error-message').forEach(el => {
                    el.style.display = 'none';
                });
            }
            
            async function loginUser() {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value.trim();
                const loginButton = document.getElementById('loginButton');
                
                hideError('loginUsernameError');
                hideError('loginPasswordError');
                
                if (!username || !password) {
                    showError('loginUsernameError', 'Заполните все поля');
                    return;
                }
                
                const originalText = loginButton.innerHTML;
                loginButton.innerHTML = '<div class="loader"></div>';
                loginButton.disabled = true;
                
                await delay(300);
                
                const user = GlobalDatabase.findUserByUsername(username);
                
                if (!user) {
                    showError('loginUsernameError', 'Пользователь не найден');
                    resetButton(loginButton, originalText);
                    return;
                }
                
                if (user.password !== password) {
                    showError('loginPasswordError', 'Неверный пароль');
                    resetButton(loginButton, originalText);
                    return;
                }
                
                // Обновляем статус в глобальной базе
                await GlobalDatabase.updateUserStatus(user.id, true);
                
                // Устанавливаем текущего пользователя
                UserData.currentUser = {
                    id: user.id,
                    username: user.username,
                    name: user.name,
                    avatar: user.avatar,
                    status: 'online',
                    online: true,
                    email: user.email
                };
                
                UserData.saveCurrentUser();
                UserData.loadContacts();
                UserData.loadMessages();
                
                // Если контактов нет, создаем начальные
                if (UserData.contacts.length === 0) {
                    UserData.createInitialContacts();
                }
                
                showMainInterface();
                showNotification('message', 'Добро пожаловать в SkyMessage!', 'Вы успешно вошли в систему.');
                
                resetButton(loginButton, originalText);
            }
            
            async function registerUser() {
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value.trim();
                const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
                const registerButton = document.getElementById('registerButton');
                
                hideError('registerUsernameError');
                hideError('registerPasswordError');
                hideError('registerConfirmPasswordError');
                
                if (!username || !password || !confirmPassword) {
                    showError('registerUsernameError', 'Заполните все поля');
                    return;
                }
                
                if (username.length < 3) {
                    showError('registerUsernameError', 'Имя пользователя должно содержать минимум 3 символа');
                    return;
                }
                
                if (GlobalDatabase.userExists(username)) {
                    showError('registerUsernameError', 'Этот никнейм уже занят');
                    return;
                }
                
                if (password.length < 6) {
                    showError('registerPasswordError', 'Пароль должен содержать минимум 6 символов');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showError('registerConfirmPasswordError', 'Пароли не совпадают');
                    return;
                }
                
                const originalText = registerButton.innerHTML;
                registerButton.innerHTML = '<div class="loader"></div>';
                registerButton.disabled = true;
                
                await delay(300);
                
                const newUser = {
                    id: 'user_' + Date.now(),
                    username: username,
                    name: username.charAt(0).toUpperCase() + username.slice(1),
                    avatar: username.charAt(0).toUpperCase(),
                    password: password,
                    status: 'online',
                    lastSeen: 'только что',
                    online: true,
                    registered: Date.now(),
                    email: username + '@skymessage.com'
                };
                
                // Добавляем в глобальную базу
                const added = await GlobalDatabase.addUser(newUser);
                if (!added) {
                    showError('registerUsernameError', 'Ошибка регистрации');
                    resetButton(registerButton, originalText);
                    return;
                }
                
                // Устанавливаем текущего пользователя
                UserData.currentUser = {
                    id: newUser.id,
                    username: newUser.username,
                    name: newUser.name,
                    avatar: newUser.avatar,
                    status: 'online',
                    online: true,
                    email: newUser.email
                };
                
                UserData.saveCurrentUser();
                UserData.contacts = [];
                UserData.messages = {};
                
                // Создаем начальные контакты
                UserData.createInitialContacts();
                
                showMainInterface();
                showNotification('message', 'Регистрация успешна!', `Добро пожаловать в SkyMessage, ${UserData.currentUser.name}!`);
                
                resetButton(registerButton, originalText);
            }
            
            async function logoutUser() {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
                
                // Обновляем статус в глобальной базе
                if (UserData.currentUser) {
                    await GlobalDatabase.updateUserStatus(UserData.currentUser.id, false);
                }
                
                UserData.clear();
                showAuthInterface();
                
                loginForm.reset();
                registerForm.reset();
                
                if (!loginForm.classList.contains('hidden')) {
                    toggleAuthForm();
                }
            }
            
            function showAuthInterface() {
                authContainer.style.display = 'flex';
                mainContainer.style.display = 'none';
                document.getElementById('searchError').style.display = 'none';
                
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
            }
            
            function showMainInterface() {
                authContainer.style.display = 'none';
                mainContainer.style.display = 'flex';
                
                document.getElementById('currentUserName').textContent = UserData.currentUser.name;
                document.getElementById('currentUserAvatar').textContent = UserData.currentUser.avatar;
                document.getElementById('currentUserStatus').textContent = 'online';
                
                renderContacts();
                resetChat();
                
                searchUserInput.value = '';
                document.getElementById('searchError').style.display = 'none';
                
                GlobalDatabase.addDebugLog(`Пользователь вошел: ${UserData.currentUser.username}`, 'success');
                GlobalDatabase.addDebugLog(`Всего пользователей: ${GlobalDatabase.getUsersCount()}`, 'info');
                GlobalDatabase.addDebugLog(`Контактов пользователя: ${UserData.contacts.length}`, 'info');
                
                startAutoRefresh();
            }
            
            function startAutoRefresh() {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
                
                refreshInterval = setInterval(async () => {
                    // Обновляем статусы демо-пользователей
                    await GlobalDatabase.updateRandomStatuses();
                    
                    // Обновляем статусы в контактах
                    UserData.contacts.forEach(contact => {
                        const user = GlobalDatabase.cache.users.find(u => u.id === contact.id);
                        if (user) {
                            contact.status = user.status;
                            contact.lastSeen = user.lastSeen;
                            contact.online = user.online;
                        }
                    });
                    UserData.saveContacts();
                    
                    if (searchUserInput.value.trim() !== '') {
                        searchUsers(searchUserInput.value);
                    } else {
                        renderContacts();
                    }
                    
                    // Если выбран контакт, обновляем его статус
                    if (currentContact) {
                        const user = GlobalDatabase.cache.users.find(u => u.id === currentContact.id);
                        if (user) {
                            document.getElementById('chatUserStatus').textContent = 
                                user.online ? 'в сети' : `был(а) ${user.lastSeen}`;
                        }
                    }
                    
                    // Периодически синхронизируем с сервером
                    if (GlobalDatabase.isOnline && Math.random() < 0.05) { // 5% вероятность
                        await GlobalDatabase.syncWithServer();
                    }
                }, 2000);
            }
            
            function searchUsers(query) {
                const searchError = document.getElementById('searchError');
                searchError.style.display = 'none';
                
                if (!query || query.trim() === '') {
                    renderContacts();
                    return;
                }
                
                GlobalDatabase.addDebugLog(`Поиск пользователей: ${query}`, 'info');
                const searchResults = GlobalDatabase.searchUsers(query, UserData.currentUser?.id);
                
                if (searchResults.length === 0) {
                    contactsContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--gray-color);">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>Пользователи не найдены</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">Попробуйте изменить поисковый запрос</p>
                        </div>
                    `;
                    return;
                }
                
                renderSearchResults(searchResults);
            }
            
            function renderContacts() {
                contactsContainer.innerHTML = '';
                
                if (UserData.contacts.length === 0) {
                    contactsContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--gray-color);">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>Контакты не найдены</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">Используйте поиск, чтобы найти других пользователей</p>
                        </div>
                    `;
                    return;
                }
                
                UserData.contacts.forEach(contact => {
                    const contactElement = createContactElement(contact, true);
                    contactsContainer.appendChild(contactElement);
                });
            }
            
            function renderSearchResults(results) {
                contactsContainer.innerHTML = '';
                
                results.forEach(user => {
                    const isContact = UserData.contacts.some(contact => contact.id === user.id);
                    const contactElement = createContactElement(user, isContact);
                    contactsContainer.appendChild(contactElement);
                });
            }
            
            function createContactElement(user, isContact) {
                const contactElement = document.createElement('div');
                contactElement.className = 'contact';
                contactElement.dataset.userId = user.id;
                
                const statusClass = user.online ? 'online' : '';
                const lastSeenText = user.online ? 'в сети' : `был(а) ${user.lastSeen}`;
                
                contactElement.innerHTML = `
                    <div class="contact-avatar">${user.avatar}</div>
                    <div class="contact-info">
                        <h4>${user.name} <span style="color: var(--gray-color); font-weight: normal; font-size: 0.8rem;">@${user.username}</span></h4>
                        <p>${lastSeenText}</p>
                    </div>
                    <div class="contact-status ${statusClass}"></div>
                `;
                
                if (!isContact) {
                    const addButton = document.createElement('button');
                    addButton.className = 'btn btn-primary btn-small add-contact-btn';
                    addButton.innerHTML = '<i class="fas fa-user-plus"></i>';
                    addButton.style.marginLeft = '10px';
                    addButton.title = 'Добавить в контакты';
                    contactElement.appendChild(addButton);
                    
                    addButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        addToContacts(user);
                    });
                }
                
                contactElement.addEventListener('click', function(e) {
                    if (!e.target.closest('.add-contact-btn')) {
                        if (isContact) {
                            const contact = UserData.contacts.find(c => c.id === user.id);
                            if (contact) selectContact(contact);
                        } else {
                            addToContacts(user);
                        }
                    }
                });
                
                return contactElement;
            }
            
            function addToContacts(user) {
                const contact = UserData.addContact(user);
                if (!contact) {
                    showNotification('message', 'Контакт уже добавлен', `${user.name} уже есть в ваших контактах`);
                    return;
                }
                
                renderContacts();
                showNotification('message', 'Контакт добавлен', `${user.name} добавлен(а) в ваши контакты`);
                selectContact(contact);
                searchUserInput.value = '';
            }
            
            function selectContact(contact) {
                document.querySelectorAll('.contact').forEach(el => {
                    el.classList.remove('active');
                });
                
                const contactElement = document.querySelector(`.contact[data-user-id="${contact.id}"]`);
                if (contactElement) {
                    contactElement.classList.add('active');
                }
                
                currentContact = contact;
                
                document.getElementById('chatUserName').textContent = contact.name;
                document.getElementById('chatUserAvatar').textContent = contact.avatar;
                document.getElementById('chatUserStatus').textContent = contact.online ? 'в сети' : `был(а) ${contact.lastSeen}`;
                
                messageInput.disabled = false;
                sendMessageButton.disabled = false;
                document.getElementById('voiceCallButton').disabled = false;
                document.getElementById('videoCallButton').disabled = false;
                
                renderMessages(contact.id);
                
                searchUserInput.value = '';
                document.getElementById('searchError').style.display = 'none';
                
                if (searchUserInput.value.trim() === '') {
                    renderContacts();
                }
            }
            
            function resetChat() {
                document.getElementById('chatUserName').textContent = 'Выберите чат';
                document.getElementById('chatUserAvatar').textContent = 'U';
                document.getElementById('chatUserStatus').textContent = 'начните общение';
                
                messageInput.disabled = true;
                sendMessageButton.disabled = true;
                document.getElementById('voiceCallButton').disabled = true;
                document.getElementById('videoCallButton').disabled = true;
                
                messagesContainer.innerHTML = `
                    <div style="text-align: center; margin-top: 50px; color: var(--gray-color);">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Выберите чат для начала общения</p>
                    </div>
                `;
                
                document.querySelectorAll('.contact').forEach(el => {
                    el.classList.remove('active');
                });
                
                currentContact = null;
            }
            
            function renderMessages(contactId) {
                const messageList = UserData.getMessages(contactId);
                
                messagesContainer.innerHTML = '';
                
                if (messageList.length === 0) {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; margin-top: 50px; color: var(--gray-color);">
                            <i class="fas fa-comment" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>Начните общение с этим пользователем</p>
                        </div>
                    `;
                    return;
                }
                
                messageList.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `message ${message.outgoing ? 'message-outgoing' : 'message-incoming'}`;
                    
                    messageElement.innerHTML = `
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">${message.time}</div>
                    `;
                    
                    messagesContainer.appendChild(messageElement);
                });
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            function sendMessage() {
                const text = messageInput.value.trim();
                
                if (!text || !currentContact) return;
                
                const newMessage = {
                    id: Date.now(),
                    text: text,
                    sender: UserData.currentUser.id,
                    time: UserData.getCurrentTime(),
                    outgoing: true,
                    timestamp: Date.now()
                };
                
                UserData.addMessage(currentContact.id, newMessage);
                renderMessages(currentContact.id);
                
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                setTimeout(() => {
                    if (currentContact) {
                        const replyMessage = {
                            id: Date.now() + 1,
                            text: getRandomReply(),
                            sender: currentContact.id,
                            time: UserData.getCurrentTime(),
                            outgoing: false,
                            timestamp: Date.now() + 1
                        };
                        
                        UserData.addMessage(currentContact.id, replyMessage);
                        renderMessages(currentContact.id);
                        
                        if (document.hidden) {
                            showNotification('message', 'Новое сообщение', `${currentContact.name}: ${replyMessage.text.substring(0, 50)}...`);
                        }
                    }
                }, 1000 + Math.random() * 2000);
            }
            
            // Вспомогательные функции
            function getRandomReply() {
                const replies = [
                    "Привет! Как дела?",
                    "Отлично, спасибо!",
                    "Что нового?",
                    "Давай созвонимся позже",
                    "Я как раз об этом думал",
                    "Интересно, расскажи подробнее",
                    "Согласен с тобой",
                    "Спасибо за информацию!",
                    "У меня все хорошо",
                    "Давай встретимся на неделе"
                ];
                return replies[Math.floor(Math.random() * replies.length)];
            }
            
            function showError(elementId, message) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = message;
                    element.style.display = 'block';
                }
            }
            
            function hideError(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'none';
                }
            }
            
            function resetButton(button, originalText) {
                button.innerHTML = originalText;
                button.disabled = false;
            }
            
            async function delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            function showNotification(type, title, text) {
                notification.className = `notification ${type}`;
                document.getElementById('notificationTitle').textContent = title;
                document.getElementById('notificationText').textContent = text;
                
                const icon = notification.querySelector('.notification-icon i');
                if (type === 'incoming-call') {
                    icon.className = 'fas fa-phone';
                    notification.classList.add('pulse');
                } else {
                    icon.className = 'fas fa-bell';
                    notification.classList.remove('pulse');
                }
                
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    notification.classList.remove('pulse');
                }, 5000);
            }
            
            // Автоматическая проверка конфигурации при загрузке
            GlobalDatabase.checkConfig();
            
            // Дебаг информация
            console.log('=== SkyMessage Debug Info ===');
            console.log('Для настройки JSONBin выполните следующие шаги:');
            console.log('1. Зайдите на https://jsonbin.io/ и создайте аккаунт');
            console.log('2. Создайте новый bin (Create New Bin)');
            console.log('3. Скопируйте Bin ID из URL (последняя часть)');
            console.log('4. В Dashboard скопируйте Secret Key (Master Key)');
            console.log('5. Замените значения в JSONBIN_CONFIG (строки 1393-1398)');
            console.log('=== Тестовые пользователи ===');
            console.log('Логин: alex_sky (и другие демо-пользователи)');
            console.log('Пароль: password123');
            console.log('=== Управление ===');
            console.log('Ctrl+Shift+D - очистить все данные');
            console.log('Кнопка "Обновить" - перепроверить соединение с API');
            console.log('Кнопка "Отладка" - показать/скрыть лог отладки');
            
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    if (confirm('Очистить ВСЕ данные приложения (включая JSONBin кэш)?')) {
                        localStorage.clear();
                        sessionStorage.clear();
                        location.reload();
                    }
                }
            });
        });
    </script>
</body>
</html>
