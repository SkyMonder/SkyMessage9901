<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyMessage - Реальный мессенджер</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Стили остаются те же, но добавлены новые */
        /* ... все предыдущие стили ... */
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 10px;
            font-size: 0.8rem;
            color: var(--gray-color);
            font-style: italic;
        }
        
        .typing-dots {
            display: flex;
            margin-left: 5px;
        }
        
        .typing-dots span {
            width: 4px;
            height: 4px;
            background-color: var(--gray-color);
            border-radius: 50%;
            margin: 0 1px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        .message-status {
            font-size: 0.7rem;
            margin-left: 5px;
            opacity: 0.7;
        }
        
        .message-status.delivered {
            color: #4caf50;
        }
        
        .message-status.read {
            color: #2196f3;
        }
    </style>
</head>
<body>
    <div class="api-status" id="apiStatus">API: Проверка...</div>
    
    <div class="container" id="appContainer">
        <div class="auth-container" id="authContainer">
            <!-- Форма входа/регистрации (остаётся без изменений) -->
        </div>
        
        <div class="main-container" id="mainContainer">
            <!-- Интерфейс чата (остаётся без изменений) -->
        </div>
    </div>

    <script>
        // ===== КОНФИГУРАЦИЯ JSONBIN.IO =====
        const JSONBIN_CONFIG = {
            // Основной BIN для пользователей
            USERS_BIN_ID: '69884cadae596e708f1a1337',
            
            // Бин для сообщений (создастся автоматически)
            MESSAGES_BIN_ID: null,
            
            // Ваш Access Key
            ACCESS_KEY: '$2a$10$I2I96lPMR/JKjetj1oc93eTQG.dkoeYEtV1j88hu5qFK8D0yAq6k2',
            
            // Версия API
            API_VERSION: 'v3',
            
            // Базовый URL
            BASE_URL: 'https://api.jsonbin.io',
            
            // Получение заголовков
            getHeaders: function() {
                return {
                    'Content-Type': 'application/json',
                    'X-Access-Key': this.ACCESS_KEY,
                    'X-Bin-Name': 'SkyMessage'
                };
            },
            
            // Получение URL для операций
            getUrl: function(binId, operation = 'read', version = 'latest') {
                if (operation === 'create') {
                    return `${this.BASE_URL}/${this.API_VERSION}/b`;
                } else if (operation === 'update') {
                    return `${this.BASE_URL}/${this.API_VERSION}/b/${binId}`;
                } else {
                    return `${this.BASE_URL}/${this.API_VERSION}/b/${binId}/${version}`;
                }
            }
        };
        
        // ===== РЕАЛЬНАЯ БАЗА ДАННЫХ =====
        const RealDatabase = {
            // Основные данные
            users: [],
            messages: {}, // Структура: { "user1_user2": [messages] }
            userStatuses: {},
            
            // Статус соединения
            isOnline: false,
            currentUserId: null,
            
            // Инициализация
            init: async function() {
                console.log('Инициализация RealDatabase...');
                
                // Загружаем данные из JSONBin
                await this.loadData();
                
                // Если нет пользователей, создаём демо
                if (this.users.length === 0) {
                    console.log('Создаём демо-пользователей...');
                    await this.createDemoUsers();
                }
                
                console.log('База данных готова. Пользователей:', this.users.length);
                this.updateApiStatus();
            },
            
            // Загрузка всех данных
            loadData: async function() {
                try {
                    // Загружаем пользователей
                    const usersResponse = await fetch(
                        JSONBIN_CONFIG.getUrl(JSONBIN_CONFIG.USERS_BIN_ID, 'read'),
                        { headers: JSONBIN_CONFIG.getHeaders() }
                    );
                    
                    if (usersResponse.ok) {
                        const data = await usersResponse.json();
                        this.users = data.record?.users || [];
                        this.userStatuses = data.record?.userStatuses || {};
                        console.log('Загружены пользователи:', this.users.length);
                    } else if (usersResponse.status === 404) {
                        console.log('Бин пользователей пустой, начинаем с чистого листа');
                        this.users = [];
                        this.userStatuses = {};
                    } else {
                        throw new Error(`Ошибка загрузки пользователей: ${usersResponse.status}`);
                    }
                    
                    this.isOnline = true;
                } catch (error) {
                    console.warn('Ошибка загрузки из JSONBin:', error);
                    this.isOnline = false;
                    
                    // Пробуем загрузить из localStorage
                    this.loadFromLocalStorage();
                }
            },
            
            // Сохранение данных
            saveData: async function() {
                if (!this.isOnline) {
                    this.saveToLocalStorage();
                    return;
                }
                
                try {
                    // Сохраняем пользователей
                    const usersData = {
                        users: this.users,
                        userStatuses: this.userStatuses,
                        lastUpdate: Date.now()
                    };
                    
                    const response = await fetch(
                        JSONBIN_CONFIG.getUrl(JSONBIN_CONFIG.USERS_BIN_ID, 'update'),
                        {
                            method: 'PUT',
                            headers: JSONBIN_CONFIG.getHeaders(),
                            body: JSON.stringify(usersData)
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`Ошибка сохранения: ${response.status}`);
                    }
                    
                    console.log('Данные сохранены в JSONBin');
                } catch (error) {
                    console.error('Ошибка сохранения в JSONBin:', error);
                    this.saveToLocalStorage();
                }
            },
            
            // Работа с localStorage
            loadFromLocalStorage: function() {
                try {
                    const data = localStorage.getItem('skyMessageRealDB');
                    if (data) {
                        const parsed = JSON.parse(data);
                        this.users = parsed.users || [];
                        this.userStatuses = parsed.userStatuses || {};
                        this.messages = parsed.messages || {};
                        console.log('Загружено из localStorage');
                    }
                } catch (e) {
                    console.error('Ошибка загрузки из localStorage:', e);
                }
            },
            
            saveToLocalStorage: function() {
                try {
                    const data = {
                        users: this.users,
                        userStatuses: this.userStatuses,
                        messages: this.messages,
                        lastUpdate: Date.now()
                    };
                    localStorage.setItem('skyMessageRealDB', JSON.stringify(data));
                } catch (e) {
                    console.error('Ошибка сохранения в localStorage:', e);
                }
            },
            
            // Обновление статуса API
            updateApiStatus: function() {
                const statusElement = document.getElementById('apiStatus');
                if (statusElement) {
                    statusElement.textContent = this.isOnline ? 'API: Онлайн' : 'API: Офлайн';
                    statusElement.className = this.isOnline ? 'api-status online' : 'api-status offline';
                }
            },
            
            // Создание демо-пользователей (РЕАЛЬНЫЕ пользователи)
            createDemoUsers: async function() {
                const demoUsers = [
                    {
                        id: 'user1',
                        username: "alex_sky",
                        name: "Александр",
                        avatar: "А",
                        password: "password123",
                        status: "online",
                        lastSeen: Date.now(),
                        online: true,
                        email: "alex@skymessage.com",
                        bio: "Разработчик, люблю технологии и путешествия",
                        registered: Date.now() - 86400000
                    },
                    {
                        id: 'user2',
                        username: "maria_chat",
                        name: "Мария",
                        avatar: "М",
                        password: "password123",
                        status: "online",
                        lastSeen: Date.now(),
                        online: true,
                        email: "maria@skymessage.com",
                        bio: "Дизайнер, увлекаюсь искусством и фотографией",
                        registered: Date.now() - 172800000
                    },
                    {
                        id: 'user3',
                        username: "max_talk",
                        name: "Максим",
                        avatar: "М",
                        password: "password123",
                        status: "offline",
                        lastSeen: Date.now() - 7200000, // 2 часа назад
                        online: false,
                        email: "max@skymessage.com",
                        bio: "Студент, изучаю программирование",
                        registered: Date.now() - 259200000
                    },
                    {
                        id: 'user4',
                        username: "anna_web",
                        name: "Анна",
                        avatar: "А",
                        password: "password123",
                        status: "online",
                        lastSeen: Date.now(),
                        online: true,
                        email: "anna@skymessage.com",
                        bio: "Маркетолог, люблю спорт и активный отдых",
                        registered: Date.now() - 345600000
                    },
                    {
                        id: 'user5',
                        username: "dmitry_conn",
                        name: "Дмитрий",
                        avatar: "Д",
                        password: "password123",
                        status: "offline",
                        lastSeen: Date.now() - 86400000, // день назад
                        online: false,
                        email: "dmitry@skymessage.com",
                        bio: "Бизнес-аналитик, увлекаюсь шахматами",
                        registered: Date.now() - 432000000
                    }
                ];
                
                this.users = demoUsers;
                await this.saveData();
            },
            
            // Поиск пользователя
            findUserByUsername: function(username) {
                return this.users.find(user => user.username === username);
            },
            
            findUserById: function(userId) {
                return this.users.find(user => user.id === userId);
            },
            
            // Проверка существования пользователя
            userExists: function(username) {
                return this.users.some(user => user.username === username);
            },
            
            // Регистрация нового пользователя
            registerUser: async function(userData) {
                if (this.userExists(userData.username)) {
                    return { success: false, error: 'Пользователь уже существует' };
                }
                
                const newUser = {
                    id: 'user_' + Date.now(),
                    username: userData.username,
                    name: userData.name,
                    avatar: userData.avatar,
                    password: userData.password,
                    status: 'online',
                    lastSeen: Date.now(),
                    online: true,
                    email: userData.email,
                    bio: userData.bio || 'Новый пользователь SkyMessage',
                    registered: Date.now()
                };
                
                this.users.push(newUser);
                await this.saveData();
                
                return { success: true, user: newUser };
            },
            
            // Авторизация пользователя
            loginUser: async function(username, password) {
                const user = this.findUserByUsername(username);
                
                if (!user) {
                    return { success: false, error: 'Пользователь не найден' };
                }
                
                if (user.password !== password) {
                    return { success: false, error: 'Неверный пароль' };
                }
                
                // Обновляем статус
                user.online = true;
                user.status = 'online';
                user.lastSeen = Date.now();
                this.userStatuses[user.id] = {
                    online: true,
                    lastSeen: Date.now()
                };
                
                await this.saveData();
                this.currentUserId = user.id;
                
                return { success: true, user: user };
            },
            
            // Выход из системы
            logoutUser: async function(userId) {
                const user = this.findUserById(userId);
                if (user) {
                    user.online = false;
                    user.status = 'offline';
                    user.lastSeen = Date.now();
                    this.userStatuses[user.id] = {
                        online: false,
                        lastSeen: Date.now()
                    };
                    await this.saveData();
                }
                this.currentUserId = null;
            },
            
            // Поиск пользователей (для добавления в контакты)
            searchUsers: function(query, excludeUserId = null) {
                if (!query || query.trim() === '') {
                    return this.users.filter(user => 
                        !excludeUserId || user.id !== excludeUserId
                    );
                }
                
                const searchQuery = query.toLowerCase().trim();
                
                return this.users.filter(user => {
                    if (excludeUserId && user.id === excludeUserId) return false;
                    
                    return user.username.toLowerCase().includes(searchQuery) ||
                           user.name.toLowerCase().includes(searchQuery) ||
                           (user.email && user.email.toLowerCase().includes(searchQuery)) ||
                           (user.bio && user.bio.toLowerCase().includes(searchQuery));
                });
            },
            
            // Получение всех пользователей кроме текущего
            getAllUsersExcept: function(excludeUserId) {
                return this.users.filter(user => user.id !== excludeUserId);
            },
            
            // Обновление статуса "печатает"
            setTypingStatus: function(userId, chatId, isTyping) {
                // В реальном приложении здесь был бы WebSocket
                console.log(`${userId} ${isTyping ? 'печатает' : 'закончил печатать'} в чате ${chatId}`);
            },
            
            // Получение истории сообщений
            getMessages: function(userId1, userId2) {
                const chatId = this.getChatId(userId1, userId2);
                return this.messages[chatId] || [];
            },
            
            // Отправка сообщения
            sendMessage: async function(fromUserId, toUserId, text) {
                const chatId = this.getChatId(fromUserId, toUserId);
                
                if (!this.messages[chatId]) {
                    this.messages[chatId] = [];
                }
                
                const message = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    text: text,
                    sender: fromUserId,
                    receiver: toUserId,
                    timestamp: Date.now(),
                    time: this.formatTime(new Date()),
                    status: 'sent', // sent, delivered, read
                    outgoing: fromUserId === this.currentUserId
                };
                
                this.messages[chatId].push(message);
                
                // Сохраняем локально
                this.saveToLocalStorage();
                
                // Пытаемся сохранить в облако
                if (this.isOnline) {
                    await this.saveMessagesToCloud();
                }
                
                return message;
            },
            
            // Генерация ID чата
            getChatId: function(userId1, userId2) {
                return [userId1, userId2].sort().join('_');
            },
            
            // Форматирование времени
            formatTime: function(date) {
                return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            },
            
            // Форматирование даты последнего посещения
            formatLastSeen: function(timestamp) {
                if (!timestamp) return 'никогда';
                
                const now = Date.now();
                const diff = now - timestamp;
                
                if (diff < 60000) return 'только что';
                if (diff < 3600000) return `${Math.floor(diff / 60000)} мин назад`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)} ч назад`;
                if (diff < 604800000) return `${Math.floor(diff / 86400000)} дн назад`;
                
                return new Date(timestamp).toLocaleDateString();
            },
            
            // Сохранение сообщений в облако (упрощённая версия)
            saveMessagesToCloud: async function() {
                // В реальном приложении здесь была бы отдельная база для сообщений
                // Сейчас сохраняем только пользователей и их статусы
                await this.saveData();
            },
            
            // Синхронизация с сервером
            sync: async function() {
                if (!this.isOnline) return false;
                
                try {
                    await this.loadData();
                    console.log('Синхронизация завершена');
                    return true;
                } catch (error) {
                    console.error('Ошибка синхронизации:', error);
                    return false;
                }
            }
        };
        
        // ===== МЕНЕДЖЕР ЧАТОВ =====
        const ChatManager = {
            currentUser: null,
            contacts: [],
            currentChat: null,
            messages: [],
            typingUsers: {},
            
            // Инициализация
            init: function(user) {
                this.currentUser = user;
                this.loadContacts();
                this.loadChats();
            },
            
            // Загрузка контактов
            loadContacts: function() {
                // Получаем всех пользователей кроме текущего
                const allUsers = RealDatabase.getAllUsersExcept(this.currentUser.id);
                
                // Преобразуем в контакты с дополнительной информацией
                this.contacts = allUsers.map(user => ({
                    id: user.id,
                    username: user.username,
                    name: user.name,
                    avatar: user.avatar,
                    status: user.online ? 'online' : 'offline',
                    lastSeen: RealDatabase.formatLastSeen(user.lastSeen),
                    online: user.online,
                    bio: user.bio,
                    unread: this.getUnreadCount(user.id)
                }));
                
                // Сохраняем в localStorage
                this.saveContacts();
            },
            
            // Загрузка чатов
            loadChats: function() {
                // В реальном приложении здесь бы загружались чаты из базы
                console.log('Чаты загружены');
            },
            
            // Сохранение контактов
            saveContacts: function() {
                if (!this.currentUser) return;
                
                try {
                    localStorage.setItem(
                        `skyMessageContacts_${this.currentUser.username}`,
                        JSON.stringify(this.contacts)
                    );
                } catch (e) {
                    console.error('Ошибка сохранения контактов:', e);
                }
            },
            
            // Получение количества непрочитанных
            getUnreadCount: function(contactId) {
                // В реальном приложении здесь бы считались непрочитанные сообщения
                return 0;
            },
            
            // Выбор чата
            selectChat: function(contact) {
                this.currentChat = contact;
                this.messages = RealDatabase.getMessages(this.currentUser.id, contact.id);
                
                // Отмечаем сообщения как прочитанные
                this.markAsRead(contact.id);
                
                return this.messages;
            },
            
            // Отправка сообщения
            sendMessage: async function(text) {
                if (!this.currentChat || !text.trim()) return null;
                
                const message = await RealDatabase.sendMessage(
                    this.currentUser.id,
                    this.currentChat.id,
                    text.trim()
                );
                
                // Добавляем в локальный список сообщений
                this.messages.push(message);
                
                // Обновляем статус "последнее сообщение" у контакта
                this.updateLastMessage(message);
                
                return message;
            },
            
            // Обновление последнего сообщения у контакта
            updateLastMessage: function(message) {
                const contact = this.contacts.find(c => c.id === this.currentChat.id);
                if (contact) {
                    contact.lastMessage = message.text;
                    contact.lastMessageTime = message.time;
                    this.saveContacts();
                }
            },
            
            // Отметка сообщений как прочитанных
            markAsRead: function(contactId) {
                // В реальном приложении здесь бы обновлялся статус в базе
                console.log(`Сообщения от ${contactId} отмечены как прочитанные`);
            },
            
            // Обновление статуса печатания
            updateTypingStatus: function(contactId, isTyping) {
                if (isTyping) {
                    this.typingUsers[contactId] = Date.now();
                } else {
                    delete this.typingUsers[contactId];
                }
            },
            
            // Проверка, печатает ли пользователь
            isTyping: function(contactId) {
                return this.typingUsers[contactId] && 
                       (Date.now() - this.typingUsers[contactId] < 5000);
            },
            
            // Добавление контакта
            addContact: function(user) {
                // Проверяем, не добавлен ли уже
                if (this.contacts.some(contact => contact.id === user.id)) {
                    return false;
                }
                
                const contact = {
                    id: user.id,
                    username: user.username,
                    name: user.name,
                    avatar: user.avatar,
                    status: user.online ? 'online' : 'offline',
                    lastSeen: RealDatabase.formatLastSeen(user.lastSeen),
                    online: user.online,
                    bio: user.bio,
                    unread: 0
                };
                
                this.contacts.push(contact);
                this.saveContacts();
                
                return contact;
            },
            
            // Очистка данных
            clear: function() {
                this.currentUser = null;
                this.contacts = [];
                this.currentChat = null;
                this.messages = [];
                this.typingUsers = {};
            }
        };
        
        // ===== ОСНОВНОЙ КОД ПРИЛОЖЕНИЯ =====
        document.addEventListener('DOMContentLoaded', async function() {
            // Инициализируем базу данных
            await RealDatabase.init();
            
            // Элементы интерфейса
            const authContainer = document.getElementById('authContainer');
            const mainContainer = document.getElementById('mainContainer');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const logoutButton = document.getElementById('logoutButton');
            const searchUserInput = document.getElementById('searchUser');
            const contactsContainer = document.getElementById('contactsContainer');
            const messagesContainer = document.getElementById('messagesContainer');
            const messageInput = document.getElementById('messageInput');
            const sendMessageButton = document.getElementById('sendMessageButton');
            
            // Переменные состояния
            let refreshInterval = null;
            let typingTimeout = null;
            
            // Проверяем авторизацию
            const savedUser = localStorage.getItem('skyMessageCurrentUser');
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    const loginResult = await RealDatabase.loginUser(user.username, user.password);
                    
                    if (loginResult.success) {
                        ChatManager.init(loginResult.user);
                        showMainInterface();
                    } else {
                        showAuthInterface();
                    }
                } catch (e) {
                    showAuthInterface();
                }
            } else {
                showAuthInterface();
            }
            
            // Настройка обработчиков событий
            setupEventListeners();
            
            function setupEventListeners() {
                // Переключение между формой входа и регистрации
                document.getElementById('toggleLink').addEventListener('click', toggleAuthForm);
                
                // Форма входа
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await loginUser();
                });
                
                // Форма регистрации
                registerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await registerUser();
                });
                
                // Выход из системы
                logoutButton.addEventListener('click', logoutUser);
                
                // Поиск пользователей
                searchUserInput.addEventListener('input', function() {
                    searchUsers(this.value);
                });
                
                // Отправка сообщения
                sendMessageButton.addEventListener('click', sendMessage);
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                // Отслеживание печатания
                messageInput.addEventListener('input', function() {
                    if (ChatManager.currentChat) {
                        clearTimeout(typingTimeout);
                        ChatManager.updateTypingStatus(ChatManager.currentChat.id, true);
                        
                        typingTimeout = setTimeout(() => {
                            ChatManager.updateTypingStatus(ChatManager.currentChat.id, false);
                        }, 1000);
                    }
                });
                
                // Автоподстройка высоты текстового поля
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }
            
            function toggleAuthForm() {
                const isLoginVisible = !loginForm.classList.contains('hidden');
                
                if (isLoginVisible) {
                    loginForm.classList.add('hidden');
                    registerForm.classList.remove('hidden');
                    document.getElementById('formTitle').textContent = 'Создайте аккаунт';
                    document.getElementById('formSubtitle').textContent = 'Зарегистрируйтесь, чтобы начать пользоваться мессенджером';
                    document.getElementById('toggleText').textContent = 'Уже есть аккаунт?';
                    document.getElementById('toggleLink').textContent = 'Войти';
                } else {
                    registerForm.classList.remove('hidden');
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                    document.getElementById('formTitle').textContent = 'Войдите в аккаунт';
                    document.getElementById('formSubtitle').textContent = 'Введите свои данные для входа в мессенджер';
                    document.getElementById('toggleText').textContent = 'Нет аккаунта?';
                    document.getElementById('toggleLink').textContent = 'Зарегистрироваться';
                }
                
                // Скрываем ошибки
                document.querySelectorAll('.error-message').forEach(el => {
                    el.style.display = 'none';
                });
            }
            
            async function loginUser() {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value.trim();
                const loginButton = document.getElementById('loginButton');
                
                hideError('loginUsernameError');
                hideError('loginPasswordError');
                
                if (!username || !password) {
                    showError('loginUsernameError', 'Заполните все поля');
                    return;
                }
                
                // Показываем индикатор загрузки
                const originalText = loginButton.innerHTML;
                loginButton.innerHTML = '<div class="loader"></div>';
                loginButton.disabled = true;
                
                try {
                    const loginResult = await RealDatabase.loginUser(username, password);
                    
                    if (loginResult.success) {
                        // Сохраняем пользователя
                        localStorage.setItem('skyMessageCurrentUser', JSON.stringify({
                            username: username,
                            password: password
                        }));
                        
                        // Инициализируем менеджер чатов
                        ChatManager.init(loginResult.user);
                        
                        showMainInterface();
                        showNotification('Добро пожаловать в SkyMessage!', `Рады видеть вас, ${loginResult.user.name}!`);
                    } else {
                        showError('loginUsernameError', loginResult.error);
                    }
                } catch (error) {
                    showError('loginUsernameError', 'Ошибка входа. Попробуйте снова.');
                } finally {
                    // Восстанавливаем кнопку
                    loginButton.innerHTML = originalText;
                    loginButton.disabled = false;
                }
            }
            
            async function registerUser() {
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value.trim();
                const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
                const registerButton = document.getElementById('registerButton');
                
                hideError('registerUsernameError');
                hideError('registerPasswordError');
                hideError('registerConfirmPasswordError');
                
                // Валидация
                if (!username || !password || !confirmPassword) {
                    showError('registerUsernameError', 'Заполните все поля');
                    return;
                }
                
                if (username.length < 3) {
                    showError('registerUsernameError', 'Имя пользователя должно содержать минимум 3 символа');
                    return;
                }
                
                if (RealDatabase.userExists(username)) {
                    showError('registerUsernameError', 'Этот никнейм уже занят');
                    return;
                }
                
                if (password.length < 6) {
                    showError('registerPasswordError', 'Пароль должен содержать минимум 6 символов');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showError('registerConfirmPasswordError', 'Пароли не совпадают');
                    return;
                }
                
                // Показываем индикатор загрузки
                const originalText = registerButton.innerHTML;
                registerButton.innerHTML = '<div class="loader"></div>';
                registerButton.disabled = true;
                
                try {
                    const registerResult = await RealDatabase.registerUser({
                        username: username,
                        name: username.charAt(0).toUpperCase() + username.slice(1),
                        avatar: username.charAt(0).toUpperCase(),
                        password: password,
                        email: username + '@skymessage.com',
                        bio: 'Новый пользователь SkyMessage'
                    });
                    
                    if (registerResult.success) {
                        // Автоматически входим
                        localStorage.setItem('skyMessageCurrentUser', JSON.stringify({
                            username: username,
                            password: password
                        }));
                        
                        ChatManager.init(registerResult.user);
                        
                        showMainInterface();
                        showNotification('Регистрация успешна!', `Добро пожаловать в SkyMessage, ${registerResult.user.name}!`);
                    } else {
                        showError('registerUsernameError', registerResult.error);
                    }
                } catch (error) {
                    showError('registerUsernameError', 'Ошибка регистрации. Попробуйте снова.');
                } finally {
                    // Восстанавливаем кнопку
                    registerButton.innerHTML = originalText;
                    registerButton.disabled = false;
                }
            }
            
            async function logoutUser() {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
                
                // Выходим из системы
                await RealDatabase.logoutUser(ChatManager.currentUser?.id);
                
                // Очищаем данные
                ChatManager.clear();
                localStorage.removeItem('skyMessageCurrentUser');
                
                showAuthInterface();
                
                // Сбрасываем формы
                loginForm.reset();
                registerForm.reset();
                
                if (!loginForm.classList.contains('hidden')) {
                    toggleAuthForm();
                }
            }
            
            function showAuthInterface() {
                authContainer.style.display = 'flex';
                mainContainer.style.display = 'none';
                document.getElementById('searchError').style.display = 'none';
                
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
            }
            
            function showMainInterface() {
                authContainer.style.display = 'none';
                mainContainer.style.display = 'flex';
                
                // Обновляем информацию о пользователе
                document.getElementById('currentUserName').textContent = ChatManager.currentUser.name;
                document.getElementById('currentUserAvatar').textContent = ChatManager.currentUser.avatar;
                document.getElementById('currentUserStatus').textContent = 'online';
                
                // Рендерим контакты
                renderContacts();
                resetChat();
                
                // Сбрасываем поиск
                searchUserInput.value = '';
                document.getElementById('searchError').style.display = 'none';
                
                console.log('Пользователь вошел:', ChatManager.currentUser.username);
                console.log('Контактов:', ChatManager.contacts.length);
                
                // Запускаем автообновление
                startAutoRefresh();
            }
            
            function startAutoRefresh() {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
                
                refreshInterval = setInterval(async () => {
                    // Синхронизируем с сервером
                    if (RealDatabase.isOnline) {
                        await RealDatabase.sync();
                    }
                    
                    // Обновляем статусы контактов
                    updateContactStatuses();
                    
                    // Обновляем отображение
                    if (searchUserInput.value.trim() !== '') {
                        searchUsers(searchUserInput.value);
                    } else {
                        renderContacts();
                    }
                    
                    // Обновляем статус текущего чата
                    if (ChatManager.currentChat) {
                        const contact = ChatManager.contacts.find(c => c.id === ChatManager.currentChat.id);
                        if (contact) {
                            document.getElementById('chatUserStatus').textContent = 
                                contact.online ? 'в сети' : `был(а) ${contact.lastSeen}`;
                            
                            // Показываем индикатор печатания
                            if (ChatManager.isTyping(contact.id)) {
                                showTypingIndicator(contact.name);
                            }
                        }
                    }
                }, 5000); // Обновляем каждые 5 секунд
            }
            
            function updateContactStatuses() {
                ChatManager.contacts.forEach(contact => {
                    const user = RealDatabase.findUserById(contact.id);
                    if (user) {
                        contact.status = user.online ? 'online' : 'offline';
                        contact.lastSeen = RealDatabase.formatLastSeen(user.lastSeen);
                        contact.online = user.online;
                    }
                });
                ChatManager.saveContacts();
            }
            
            function searchUsers(query) {
                const searchError = document.getElementById('searchError');
                searchError.style.display = 'none';
                
                if (!query || query.trim() === '') {
                    renderContacts();
                    return;
                }
                
                const searchResults = RealDatabase.searchUsers(query, ChatManager.currentUser?.id);
                
                if (searchResults.length === 0) {
                    contactsContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--gray-color);">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>Пользователи не найдены</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">Попробуйте изменить поисковый запрос</p>
                        </div>
                    `;
                    return;
                }
                
                renderSearchResults(searchResults);
            }
            
            function renderContacts() {
                contactsContainer.innerHTML = '';
                
                if (ChatManager.contacts.length === 0) {
                    contactsContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--gray-color);">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>Контакты не найдены</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">Используйте поиск, чтобы найти других пользователей</p>
                        </div>
                    `;
                    return;
                }
                
                ChatManager.contacts.forEach(contact => {
                    const contactElement = createContactElement(contact, true);
                    contactsContainer.appendChild(contactElement);
                });
            }
            
            function renderSearchResults(results) {
                contactsContainer.innerHTML = '';
                
                results.forEach(user => {
                    const isContact = ChatManager.contacts.some(contact => contact.id === user.id);
                    const contactElement = createContactElement(user, isContact);
                    contactsContainer.appendChild(contactElement);
                });
            }
            
            function createContactElement(user, isContact) {
                const contactElement = document.createElement('div');
                contactElement.className = 'contact';
                contactElement.dataset.userId = user.id;
                
                const statusClass = user.online ? 'online' : '';
                const lastSeenText = user.online ? 'в сети' : `был(а) ${RealDatabase.formatLastSeen(user.lastSeen)}`;
                
                contactElement.innerHTML = `
                    <div class="contact-avatar">${user.avatar}</div>
                    <div class="contact-info">
                        <h4>${user.name} <span style="color: var(--gray-color); font-weight: normal; font-size: 0.8rem;">@${user.username}</span></h4>
                        <p>${lastSeenText}</p>
                        ${user.bio ? `<p style="font-size: 0.8rem; color: var(--gray-color); margin-top: 2px;">${user.bio.substring(0, 30)}${user.bio.length > 30 ? '...' : ''}</p>` : ''}
                    </div>
                    <div class="contact-status ${statusClass}"></div>
                `;
                
                if (!isContact) {
                    const addButton = document.createElement('button');
                    addButton.className = 'btn btn-primary btn-small add-contact-btn';
                    addButton.innerHTML = '<i class="fas fa-user-plus"></i>';
                    addButton.style.marginLeft = '10px';
                    addButton.title = 'Добавить в контакты';
                    contactElement.appendChild(addButton);
                    
                    addButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        addToContacts(user);
                    });
                }
                
                contactElement.addEventListener('click', function(e) {
                    if (!e.target.closest('.add-contact-btn')) {
                        if (isContact) {
                            const contact = ChatManager.contacts.find(c => c.id === user.id);
                            if (contact) selectContact(contact);
                        } else {
                            addToContacts(user);
                        }
                    }
                });
                
                return contactElement;
            }
            
            function addToContacts(user) {
                const contact = ChatManager.addContact(user);
                if (!contact) {
                    showNotification('Контакт уже добавлен', `${user.name} уже есть в ваших контактах`);
                    return;
                }
                
                renderContacts();
                showNotification('Контакт добавлен', `${user.name} добавлен(а) в ваши контакты`);
                selectContact(contact);
                searchUserInput.value = '';
            }
            
            function selectContact(contact) {
                // Убираем выделение со всех контактов
                document.querySelectorAll('.contact').forEach(el => {
                    el.classList.remove('active');
                });
                
                // Выделяем выбранный контакт
                const contactElement = document.querySelector(`.contact[data-user-id="${contact.id}"]`);
                if (contactElement) {
                    contactElement.classList.add('active');
                }
                
                // Загружаем сообщения
                const messages = ChatManager.selectChat(contact);
                
                // Обновляем интерфейс чата
                document.getElementById('chatUserName').textContent = contact.name;
                document.getElementById('chatUserAvatar').textContent = contact.avatar;
                document.getElementById('chatUserStatus').textContent = contact.online ? 'в сети' : `был(а) ${contact.lastSeen}`;
                
                // Активируем поле ввода
                messageInput.disabled = false;
                sendMessageButton.disabled = false;
                document.getElementById('voiceCallButton').disabled = false;
                document.getElementById('videoCallButton').disabled = false;
                
                // Рендерим сообщения
                renderMessages(messages);
                
                // Сбрасываем поиск
                searchUserInput.value = '';
                document.getElementById('searchError').style.display = 'none';
                
                if (searchUserInput.value.trim() === '') {
                    renderContacts();
                }
            }
            
            function resetChat() {
                document.getElementById('chatUserName').textContent = 'Выберите чат';
                document.getElementById('chatUserAvatar').textContent = 'U';
                document.getElementById('chatUserStatus').textContent = 'начните общение';
                
                messageInput.disabled = true;
                sendMessageButton.disabled = true;
                document.getElementById('voiceCallButton').disabled = true;
                document.getElementById('videoCallButton').disabled = true;
                
                messagesContainer.innerHTML = `
                    <div style="text-align: center; margin-top: 50px; color: var(--gray-color);">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Выберите чат для начала общения</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Используйте поиск, чтобы найти пользователей</p>
                    </div>
                `;
                
                document.querySelectorAll('.contact').forEach(el => {
                    el.classList.remove('active');
                });
                
                ChatManager.currentChat = null;
            }
            
            function renderMessages(messages) {
                messagesContainer.innerHTML = '';
                
                if (messages.length === 0) {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; margin-top: 50px; color: var(--gray-color);">
                            <i class="fas fa-comment" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>Начните общение с этим пользователем</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">Отправьте первое сообщение!</p>
                        </div>
                    `;
                    return;
                }
                
                messages.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `message ${message.outgoing ? 'message-outgoing' : 'message-incoming'}`;
                    
                    const statusIcon = message.outgoing ? 
                        `<i class="fas fa-check${message.status === 'read' ? '-double' : ''} message-status ${message.status}"></i>` : '';
                    
                    messageElement.innerHTML = `
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">${message.time} ${statusIcon}</div>
                    `;
                    
                    messagesContainer.appendChild(messageElement);
                });
                
                // Прокручиваем вниз
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            function showTypingIndicator(userName) {
                // Удаляем старый индикатор
                const oldIndicator = document.querySelector('.typing-indicator');
                if (oldIndicator) oldIndicator.remove();
                
                // Создаем новый индикатор
                const indicator = document.createElement('div');
                indicator.className = 'typing-indicator';
                indicator.innerHTML = `
                    <span>${userName} печатает</span>
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                `;
                
                messagesContainer.appendChild(indicator);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            async function sendMessage() {
                const text = messageInput.value.trim();
                
                if (!text || !ChatManager.currentChat) return;
                
                // Отправляем сообщение
                const message = await ChatManager.sendMessage(text);
                
                if (message) {
                    // Обновляем отображение
                    renderMessages(ChatManager.messages);
                    
                    // Очищаем поле ввода
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    
                    // Показываем уведомление
                    showNotification('Сообщение отправлено', `Сообщение отправлено ${ChatManager.currentChat.name}`);
                }
            }
            
            // Вспомогательные функции
            function showError(elementId, message) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = message;
                    element.style.display = 'block';
                }
            }
            
            function hideError(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'none';
                }
            }
            
            function showNotification(title, text) {
                // Создаем уведомление
                const notification = document.createElement('div');
                notification.className = 'notification message show';
                notification.innerHTML = `
                    <div class="notification-icon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="notification-content">
                        <h4>${title}</h4>
                        <p>${text}</p>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Удаляем через 5 секунд
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }
            
            // Дебаг информация
            console.log('=== SkyMessage Real Version ===');
            console.log('Теперь это РЕАЛЬНЫЙ мессенджер:');
            console.log('1. Пользователи сохраняются в JSONBin.io');
            console.log('2. Сообщения сохраняются локально и синхронизируются');
            console.log('3. НЕТ авто-ответчиков - реальные пользователи');
            console.log('4. Все данные сохраняются между сессиями');
            console.log('=== Тестовые пользователи ===');
            console.log('alex_sky / password123');
            console.log('maria_chat / password123');
            console.log('max_talk / password123');
            console.log('anna_web / password123');
            console.log('dmitry_conn / password123');
            
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    if (confirm('Очистить ВСЕ данные приложения?')) {
                        localStorage.clear();
                        location.reload();
                    }
                }
            });
        });
    </script>
</body>
</html>
