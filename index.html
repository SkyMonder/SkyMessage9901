<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyMessage - Новый мессенджер</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #7209b7;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --border-color: #e0e0e0;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background-color: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            display: flex;
            transition: var(--transition);
        }

        /* Авторизация */
        .auth-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .auth-form {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background-color: white;
        }

        .auth-illustration {
            flex: 1;
            background: linear-gradient(to bottom right, var(--primary-color), var(--secondary-color));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: white;
        }

        .auth-illustration h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .auth-illustration p {
            font-size: 1.2rem;
            opacity: 0.9;
            text-align: center;
            line-height: 1.6;
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-size: 1.8rem;
        }

        .logo-text {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .form-subtitle {
            color: var(--gray-color);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            padding: 14px 20px;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--light-color);
            color: var(--dark-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: #e9ecef;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .toggle-form {
            text-align: center;
            margin-top: 20px;
            color: var(--gray-color);
        }

        .toggle-form a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .error-message {
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }

        /* Основной интерфейс мессенджера */
        .main-container {
            display: none;
            width: 100%;
            height: 100%;
        }

        /* Боковая панель контактов */
        .sidebar {
            width: 350px;
            background-color: #f8f9fa;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .user-info {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            background-color: white;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            margin-right: 15px;
        }

        .user-details h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .user-details p {
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        .search-container {
            padding: 20px;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 0.95rem;
            background-color: #f8f9fa;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .contacts-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .contact {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 5px;
        }

        .contact:hover {
            background-color: #e9ecef;
        }

        .contact.active {
            background-color: #e3f2fd;
        }

        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 15px;
        }

        .contact-info h4 {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .contact-info p {
            color: var(--gray-color);
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .contact-status {
            margin-left: auto;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .contact-status.online {
            background-color: #4caf50;
        }

        /* Область чата */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: white;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
        }

        .chat-header-buttons {
            display: flex;
            gap: 10px;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 15px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message-outgoing {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message-incoming {
            align-self: flex-start;
            background-color: white;
            color: var(--dark-color);
            border-bottom-left-radius: 5px;
            border: 1px solid var(--border-color);
        }

        .message-time {
            font-size: 0.75rem;
            margin-top: 5px;
            opacity: 0.8;
            text-align: right;
        }

        .message-input-container {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            background-color: white;
        }

        .message-input {
            flex: 1;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            resize: none;
            max-height: 100px;
        }

        .send-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .send-button:hover {
            background-color: var(--primary-dark);
            transform: scale(1.05);
        }

        /* Окно звонка */
        .call-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .call-info {
            text-align: center;
            margin-bottom: 40px;
        }

        .call-info h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .call-info p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .video-container {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            max-width: 1200px;
            width: 90%;
        }

        .video-box {
            flex: 1;
            border-radius: 10px;
            overflow: hidden;
            background-color: #333;
            position: relative;
            aspect-ratio: 16/9;
        }

        .video-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .call-controls {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .call-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            border: none;
        }

        .call-button.accept {
            background-color: #4caf50;
            color: white;
        }

        .call-button.decline {
            background-color: #f44336;
            color: white;
        }

        .call-button.end {
            background-color: #f44336;
            color: white;
        }

        .call-button.toggle {
            background-color: #2196f3;
            color: white;
        }

        .call-button:hover {
            transform: scale(1.1);
        }

        .device-selectors {
            margin-top: 20px;
            display: flex;
            gap: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .device-selector {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .device-selector select {
            padding: 8px 12px;
            border-radius: 5px;
            background-color: #333;
            color: white;
            border: none;
        }

        /* Уведомления */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: white;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 100;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .notification.incoming-call .notification-icon {
            background-color: var(--primary-color);
        }

        .notification.message .notification-icon {
            background-color: var(--success-color);
        }

        .notification-content h4 {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .notification-content p {
            font-size: 0.9rem;
            color: var(--gray-color);
        }

        .notification-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .container {
                height: 95vh;
                border-radius: 10px;
            }
            
            .auth-container {
                flex-direction: column;
            }
            
            .auth-illustration {
                padding: 20px;
                order: -1;
            }
            
            .auth-illustration h2 {
                font-size: 1.8rem;
            }
            
            .auth-form {
                padding: 30px 20px;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .video-container {
                flex-direction: column;
                width: 95%;
            }
            
            .call-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .device-selectors {
                flex-direction: column;
                width: 90%;
            }
        }

        /* Анимации */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Скрытые элементы */
        .hidden {
            display: none;
        }

        .visible {
            display: flex;
        }
    </style>
</head>
<body>
    <!-- Контейнер приложения -->
    <div class="container" id="appContainer">
        <!-- Экран авторизации -->
        <div class="auth-container" id="authContainer">
            <div class="auth-form">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="logo-text">SkyMessage</div>
                </div>
                
                <h2 class="form-title" id="formTitle">Войдите в аккаунт</h2>
                <p class="form-subtitle" id="formSubtitle">Введите свои данные для входа в мессенджер</p>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="loginUsername">Имя пользователя</label>
                        <input type="text" class="form-input" id="loginUsername" placeholder="Введите ваш никнейм">
                        <div class="error-message" id="loginUsernameError">Пользователь не найден</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Пароль</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Введите ваш пароль">
                        <div class="error-message" id="loginPasswordError">Неверный пароль</div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Войти
                    </button>
                </form>
                
                <form id="registerForm" class="hidden">
                    <div class="form-group">
                        <label class="form-label" for="registerUsername">Имя пользователя</label>
                        <input type="text" class="form-input" id="registerUsername" placeholder="Придумайте уникальный никнейм">
                        <div class="error-message" id="registerUsernameError">Этот никнейм уже занят</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="registerPassword">Пароль</label>
                        <input type="password" class="form-input" id="registerPassword" placeholder="Придумайте надежный пароль">
                        <div class="error-message" id="registerPasswordError">Пароль должен содержать минимум 6 символов</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="registerConfirmPassword">Подтверждение пароля</label>
                        <input type="password" class="form-input" id="registerConfirmPassword" placeholder="Повторите пароль">
                        <div class="error-message" id="registerConfirmPasswordError">Пароли не совпадают</div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Зарегистрироваться
                    </button>
                </form>
                
                <div class="toggle-form">
                    <span id="toggleText">Нет аккаунта?</span>
                    <a id="toggleLink">Зарегистрироваться</a>
                </div>
            </div>
            
            <div class="auth-illustration">
                <h2>SkyMessage</h2>
                <p>Новый способ общения. Отправляйте сообщения, совершайте видеозвонки и оставайтесь на связи с близкими в любое время и в любом месте.</p>
                <div style="margin-top: 40px; font-size: 5rem; opacity: 0.8;">
                    <i class="fas fa-comment-dots"></i>
                </div>
            </div>
        </div>
        
        <!-- Основной интерфейс мессенджера -->
        <div class="main-container" id="mainContainer">
            <!-- Боковая панель контактов -->
            <div class="sidebar">
                <div class="user-info">
                    <div class="user-avatar" id="currentUserAvatar">U</div>
                    <div class="user-details">
                        <h3 id="currentUserName">Пользователь</h3>
                        <p id="currentUserStatus">online</p>
                    </div>
                    <button class="btn btn-secondary btn-small" id="logoutButton" style="margin-left: auto;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
                
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchUser" placeholder="Найти пользователя по никнейму">
                    </div>
                </div>
                
                <div class="contacts-container" id="contactsContainer">
                    <!-- Контакты будут добавляться здесь динамически -->
                </div>
            </div>
            
            <!-- Область чата -->
            <div class="chat-container">
                <div class="chat-header" id="chatHeader">
                    <div class="chat-user-info">
                        <div class="contact-avatar" id="chatUserAvatar">U</div>
                        <div>
                            <h3 id="chatUserName">Выберите чат</h3>
                            <p id="chatUserStatus">начните общение</p>
                        </div>
                    </div>
                    
                    <div class="chat-header-buttons">
                        <button class="btn btn-secondary btn-small" id="voiceCallButton" disabled>
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="btn btn-secondary btn-small" id="videoCallButton" disabled>
                            <i class="fas fa-video"></i>
                        </button>
                    </div>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <!-- Сообщения будут добавляться здесь динамически -->
                    <div style="text-align: center; margin-top: 50px; color: var(--gray-color);">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Выберите чат для начала общения</p>
                    </div>
                </div>
                
                <div class="message-input-container">
                    <textarea class="message-input" id="messageInput" placeholder="Введите сообщение..." rows="1" disabled></textarea>
                    <button class="send-button" id="sendMessageButton" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Окно звонка -->
    <div class="call-container" id="callContainer">
        <div class="call-info">
            <h2 id="callTitle">Входящий видеозвонок</h2>
            <p id="callDescription">Пользователь звонит вам</p>
        </div>
        
        <div class="video-container">
            <div class="video-box">
                <video id="localVideo" autoplay muted></video>
                <div class="video-label">Вы</div>
            </div>
            
            <div class="video-box">
                <video id="remoteVideo" autoplay></video>
                <div class="video-label" id="remoteUserName">Собеседник</div>
            </div>
        </div>
        
        <div class="call-controls">
            <button class="call-button accept" id="acceptCallButton">
                <i class="fas fa-phone"></i>
            </button>
            <button class="call-button decline" id="declineCallButton">
                <i class="fas fa-phone-slash"></i>
            </button>
            <button class="call-button toggle" id="toggleVideoButton">
                <i class="fas fa-video"></i>
            </button>
            <button class="call-button toggle" id="toggleAudioButton">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="call-button end hidden" id="endCallButton">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
        
        <div class="device-selectors">
            <div class="device-selector">
                <label for="cameraSelect">Камера:</label>
                <select id="cameraSelect"></select>
            </div>
            <div class="device-selector">
                <label for="microphoneSelect">Микрофон:</label>
                <select id="microphoneSelect"></select>
            </div>
        </div>
    </div>
    
    <!-- Уведомления -->
    <div class="notification" id="notification">
        <div class="notification-icon">
            <i class="fas fa-bell"></i>
        </div>
        <div class="notification-content">
            <h4 id="notificationTitle">Уведомление</h4>
            <p id="notificationText">Текст уведомления</p>
            <div class="notification-actions" id="notificationActions"></div>
        </div>
    </div>

    <script>
        // Основной код приложения
        document.addEventListener('DOMContentLoaded', function() {
            // Элементы интерфейса
            const appContainer = document.getElementById('appContainer');
            const authContainer = document.getElementById('authContainer');
            const mainContainer = document.getElementById('mainContainer');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const toggleLink = document.getElementById('toggleLink');
            const toggleText = document.getElementById('toggleText');
            const formTitle = document.getElementById('formTitle');
            const formSubtitle = document.getElementById('formSubtitle');
            const logoutButton = document.getElementById('logoutButton');
            const searchUserInput = document.getElementById('searchUser');
            const contactsContainer = document.getElementById('contactsContainer');
            const chatHeader = document.getElementById('chatHeader');
            const messagesContainer = document.getElementById('messagesContainer');
            const messageInput = document.getElementById('messageInput');
            const sendMessageButton = document.getElementById('sendMessageButton');
            const voiceCallButton = document.getElementById('voiceCallButton');
            const videoCallButton = document.getElementById('videoCallButton');
            const callContainer = document.getElementById('callContainer');
            const acceptCallButton = document.getElementById('acceptCallButton');
            const declineCallButton = document.getElementById('declineCallButton');
            const endCallButton = document.getElementById('endCallButton');
            const toggleVideoButton = document.getElementById('toggleVideoButton');
            const toggleAudioButton = document.getElementById('toggleAudioButton');
            const cameraSelect = document.getElementById('cameraSelect');
            const microphoneSelect = document.getElementById('microphoneSelect');
            const localVideo = document.getElementById('localVideo');
            const remoteVideo = document.getElementById('remoteVideo');
            const callTitle = document.getElementById('callTitle');
            const callDescription = document.getElementById('callDescription');
            const remoteUserName = document.getElementById('remoteUserName');
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationText = document.getElementById('notificationText');
            const notificationActions = document.getElementById('notificationActions');
            
            // Переменные состояния приложения
            let currentUser = null;
            let users = [];
            let contacts = [];
            let currentContact = null;
            let messages = {};
            let peerConnection = null;
            let localStream = null;
            let remoteStream = null;
            let isCaller = false;
            let callInProgress = false;
            let currentCallType = null; // 'video' или 'voice'
            let isVideoEnabled = true;
            let isAudioEnabled = true;
            let cameras = [];
            let microphones = [];
            
            // Инициализация приложения
            initApp();
            
            // Функция инициализации
            function initApp() {
                // Проверяем, авторизован ли пользователь
                const savedUser = localStorage.getItem('skyMessageUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    showMainInterface();
                }
                
                // Загружаем тестовые данные
                loadTestData();
                
                // Настройка обработчиков событий
                setupEventListeners();
                
                // Загружаем доступные устройства
                loadMediaDevices();
            }
            
            // Загрузка тестовых данных
            function loadTestData() {
                // Тестовые пользователи
                users = [
                    { id: 1, username: "alex_sky", name: "Александр", avatar: "А", status: "online", lastSeen: "только что" },
                    { id: 2, username: "maria_chat", name: "Мария", avatar: "М", status: "online", lastSeen: "5 минут назад" },
                    { id: 3, username: "max_talk", name: "Максим", avatar: "М", status: "offline", lastSeen: "2 часа назад" },
                    { id: 4, username: "anna_web", name: "Анна", avatar: "А", status: "online", lastSeen: "в сети" },
                    { id: 5, username: "dmitry_conn", name: "Дмитрий", avatar: "Д", status: "offline", lastSeen: "вчера" }
                ];
                
                // Тестовые контакты (первые 3 пользователя)
                contacts = users.slice(0, 3);
                
                // Тестовые сообщения
                messages = {
                    1: [
                        { id: 1, text: "Привет! Как дела?", sender: 1, time: "10:30", outgoing: false },
                        { id: 2, text: "Привет! Все отлично, спасибо! А у тебя?", sender: "current", time: "10:32", outgoing: true },
                        { id: 3, text: "Тоже хорошо! Слушай, можешь помочь с проектом?", sender: 1, time: "10:33", outgoing: false }
                    ],
                    2: [
                        { id: 1, text: "Добрый день! Напомни, пожалуйста, о встрече завтра.", sender: "current", time: "09:15", outgoing: true },
                        { id: 2, text: "Конечно! Встреча в 14:00 в конференц-зале.", sender: 2, time: "09:16", outgoing: false }
                    ],
                    3: [
                        { id: 1, text: "Привет! Ты смотрел новый фильм?", sender: 3, time: "вчера", outgoing: false },
                        { id: 2, text: "Да, смотрел! Очень понравился, особенно спецэффекты.", sender: "current", time: "вчера", outgoing: true }
                    ]
                };
            }
            
            // Настройка обработчиков событий
            function setupEventListeners() {
                // Переключение между формой входа и регистрации
                toggleLink.addEventListener('click', toggleAuthForm);
                
                // Форма входа
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    loginUser();
                });
                
                // Форма регистрации
                registerForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    registerUser();
                });
                
                // Выход из системы
                logoutButton.addEventListener('click', logoutUser);
                
                // Поиск пользователей
                searchUserInput.addEventListener('input', searchUsers);
                
                // Отправка сообщения
                sendMessageButton.addEventListener('click', sendMessage);
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                // Автоматическое изменение высоты поля ввода сообщения
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
                
                // Кнопки звонков
                voiceCallButton.addEventListener('click', function() {
                    startCall('voice');
                });
                
                videoCallButton.addEventListener('click', function() {
                    startCall('video');
                });
                
                // Кнопки управления звонком
                acceptCallButton.addEventListener('click', acceptCall);
                declineCallButton.addEventListener('click', declineCall);
                endCallButton.addEventListener('click', endCall);
                toggleVideoButton.addEventListener('click', toggleVideo);
                toggleAudioButton.addEventListener('click', toggleAudio);
                
                // Выбор устройств
                cameraSelect.addEventListener('change', changeCamera);
                microphoneSelect.addEventListener('change', changeMicrophone);
                
                // Закрытие уведомления
                notification.addEventListener('click', function() {
                    hideNotification();
                });
            }
            
            // Переключение между формой входа и регистрации
            function toggleAuthForm() {
                const isLoginVisible = !loginForm.classList.contains('hidden');
                
                if (isLoginVisible) {
                    // Переключаемся на регистрацию
                    loginForm.classList.add('hidden');
                    registerForm.classList.remove('hidden');
                    formTitle.textContent = 'Создайте аккаунт';
                    formSubtitle.textContent = 'Зарегистрируйтесь, чтобы начать пользоваться мессенджером';
                    toggleText.textContent = 'Уже есть аккаунт?';
                    toggleLink.textContent = 'Войти';
                } else {
                    // Переключаемся на вход
                    registerForm.classList.remove('hidden');
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                    formTitle.textContent = 'Войдите в аккаунт';
                    formSubtitle.textContent = 'Введите свои данные для входа в мессенджер';
                    toggleText.textContent = 'Нет аккаунта?';
                    toggleLink.textContent = 'Зарегистрироваться';
                }
                
                // Сбрасываем ошибки
                document.querySelectorAll('.error-message').forEach(el => {
                    el.style.display = 'none';
                });
            }
            
            // Вход пользователя
            function loginUser() {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value.trim();
                
                // Сбрасываем ошибки
                document.getElementById('loginUsernameError').style.display = 'none';
                document.getElementById('loginPasswordError').style.display = 'none';
                
                // Проверка введенных данных
                if (!username || !password) {
                    showError('loginUsernameError', 'Заполните все поля');
                    return;
                }
                
                // Имитация проверки на сервере
                // В реальном приложении здесь был бы запрос к серверу
                
                // Проверяем, существует ли пользователь
                const userExists = users.some(user => user.username === username);
                
                if (!userExists) {
                    showError('loginUsernameError', 'Пользователь не найден');
                    return;
                }
                
                // Проверяем пароль (в реальном приложении проверялся бы хэш)
                if (password.length < 6) {
                    showError('loginPasswordError', 'Неверный пароль');
                    return;
                }
                
                // Успешный вход
                currentUser = {
                    id: 'current',
                    username: username,
                    name: username.charAt(0).toUpperCase() + username.slice(1),
                    avatar: username.charAt(0).toUpperCase(),
                    status: 'online'
                };
                
                // Сохраняем пользователя в localStorage
                localStorage.setItem('skyMessageUser', JSON.stringify(currentUser));
                
                // Показываем основной интерфейс
                showMainInterface();
                
                // Показываем уведомление
                showNotification('message', 'Добро пожаловать в SkyMessage!', 'Вы успешно вошли в систему.');
            }
            
            // Регистрация пользователя
            function registerUser() {
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value.trim();
                const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
                
                // Сбрасываем ошибки
                document.getElementById('registerUsernameError').style.display = 'none';
                document.getElementById('registerPasswordError').style.display = 'none';
                document.getElementById('registerConfirmPasswordError').style.display = 'none';
                
                // Проверка введенных данных
                if (!username || !password || !confirmPassword) {
                    showError('registerUsernameError', 'Заполните все поля');
                    return;
                }
                
                // Проверка имени пользователя
                if (username.length < 3) {
                    showError('registerUsernameError', 'Имя пользователя должно содержать минимум 3 символа');
                    return;
                }
                
                // Проверка, занят ли никнейм
                const usernameTaken = users.some(user => user.username === username);
                if (usernameTaken) {
                    showError('registerUsernameError', 'Этот никнейм уже занят');
                    return;
                }
                
                // Проверка пароля
                if (password.length < 6) {
                    showError('registerPasswordError', 'Пароль должен содержать минимум 6 символов');
                    return;
                }
                
                // Проверка подтверждения пароля
                if (password !== confirmPassword) {
                    showError('registerConfirmPasswordError', 'Пароли не совпадают');
                    return;
                }
                
                // Успешная регистрация
                const newUser = {
                    id: users.length + 1,
                    username: username,
                    name: username.charAt(0).toUpperCase() + username.slice(1),
                    avatar: username.charAt(0).toUpperCase(),
                    status: 'online',
                    lastSeen: 'только что'
                };
                
                // Добавляем пользователя в список
                users.push(newUser);
                
                // Автоматически добавляем его в контакты
                contacts.push(newUser);
                
                // Устанавливаем текущего пользователя
                currentUser = {
                    id: 'current',
                    username: username,
                    name: username.charAt(0).toUpperCase() + username.slice(1),
                    avatar: username.charAt(0).toUpperCase(),
                    status: 'online'
                };
                
                // Сохраняем пользователя в localStorage
                localStorage.setItem('skyMessageUser', JSON.stringify(currentUser));
                
                // Показываем основной интерфейс
                showMainInterface();
                
                // Показываем уведомление
                showNotification('message', 'Регистрация успешна!', 'Добро пожаловать в SkyMessage!');
            }
            
            // Выход пользователя
            function logoutUser() {
                // Завершаем звонок, если он активен
                if (callInProgress) {
                    endCall();
                }
                
                // Очищаем данные
                currentUser = null;
                localStorage.removeItem('skyMessageUser');
                
                // Показываем интерфейс авторизации
                showAuthInterface();
                
                // Сбрасываем формы
                loginForm.reset();
                registerForm.reset();
                
                // Показываем форму входа
                if (!loginForm.classList.contains('hidden')) {
                    toggleAuthForm();
                }
            }
            
            // Показать интерфейс авторизации
            function showAuthInterface() {
                authContainer.style.display = 'flex';
                mainContainer.style.display = 'none';
                callContainer.style.display = 'none';
            }
            
            // Показать основной интерфейс
            function showMainInterface() {
                authContainer.style.display = 'none';
                mainContainer.style.display = 'flex';
                
                // Обновляем информацию о текущем пользователе
                document.getElementById('currentUserName').textContent = currentUser.name;
                document.getElementById('currentUserAvatar').textContent = currentUser.avatar;
                
                // Отображаем контакты
                renderContacts();
                
                // Сбрасываем текущий чат
                resetChat();
            }
            
            // Поиск пользователей
            function searchUsers() {
                const query = searchUserInput.value.trim().toLowerCase();
                
                if (query === '') {
                    // Если поисковой запрос пустой, показываем все контакты
                    renderContacts();
                    return;
                }
                
                // Фильтруем пользователей по запросу
                const filteredUsers = users.filter(user => 
                    user.username.toLowerCase().includes(query) || 
                    user.name.toLowerCase().includes(query)
                );
                
                // Отображаем результаты поиска
                renderSearchResults(filteredUsers);
            }
            
            // Отображение контактов
            function renderContacts() {
                contactsContainer.innerHTML = '';
                
                if (contacts.length === 0) {
                    contactsContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--gray-color);">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>Контакты не найдены</p>
                        </div>
                    `;
                    return;
                }
                
                contacts.forEach(contact => {
                    const contactElement = document.createElement('div');
                    contactElement.className = 'contact';
                    contactElement.dataset.userId = contact.id;
                    
                    // Определяем статус
                    const statusClass = contact.status === 'online' ? 'online' : '';
                    const lastSeenText = contact.status === 'online' ? 'в сети' : `был(а) ${contact.lastSeen}`;
                    
                    contactElement.innerHTML = `
                        <div class="contact-avatar">${contact.avatar}</div>
                        <div class="contact-info">
                            <h4>${contact.name}</h4>
                            <p>${lastSeenText}</p>
                        </div>
                        <div class="contact-status ${statusClass}"></div>
                    `;
                    
                    // Обработчик клика по контакту
                    contactElement.addEventListener('click', function() {
                        selectContact(contact);
                    });
                    
                    contactsContainer.appendChild(contactElement);
                });
            }
            
            // Отображение результатов поиска
            function renderSearchResults(results) {
                contactsContainer.innerHTML = '';
                
                if (results.length === 0) {
                    contactsContainer.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: var(--gray-color);">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>Пользователи не найдены</p>
                        </div>
                    `;
                    return;
                }
                
                results.forEach(user => {
                    // Проверяем, есть ли пользователь уже в контактах
                    const isContact = contacts.some(contact => contact.id === user.id);
                    
                    const userElement = document.createElement('div');
                    userElement.className = 'contact';
                    userElement.dataset.userId = user.id;
                    
                    // Определяем статус
                    const statusClass = user.status === 'online' ? 'online' : '';
                    const lastSeenText = user.status === 'online' ? 'в сети' : `был(а) ${user.lastSeen}`;
                    
                    userElement.innerHTML = `
                        <div class="contact-avatar">${user.avatar}</div>
                        <div class="contact-info">
                            <h4>${user.name} <span style="color: var(--gray-color); font-weight: normal;">@${user.username}</span></h4>
                            <p>${lastSeenText}</p>
                        </div>
                        <div class="contact-status ${statusClass}"></div>
                    `;
                    
                    // Обработчик клика по пользователю
                    userElement.addEventListener('click', function() {
                        if (isContact) {
                            // Если пользователь уже в контактах, открываем чат
                            selectContact(user);
                        } else {
                            // Иначе добавляем в контакты
                            addToContacts(user);
                        }
                    });
                    
                    contactsContainer.appendChild(userElement);
                });
            }
            
            // Выбор контакта для чата
            function selectContact(contact) {
                // Снимаем выделение со всех контактов
                document.querySelectorAll('.contact').forEach(el => {
                    el.classList.remove('active');
                });
                
                // Выделяем выбранный контакт
                const contactElement = document.querySelector(`.contact[data-user-id="${contact.id}"]`);
                if (contactElement) {
                    contactElement.classList.add('active');
                }
                
                // Устанавливаем текущий контакт
                currentContact = contact;
                
                // Обновляем заголовок чата
                document.getElementById('chatUserName').textContent = contact.name;
                document.getElementById('chatUserAvatar').textContent = contact.avatar;
                document.getElementById('chatUserStatus').textContent = contact.status === 'online' ? 'в сети' : `был(а) ${contact.lastSeen}`;
                
                // Включаем поле ввода и кнопки
                messageInput.disabled = false;
                sendMessageButton.disabled = false;
                voiceCallButton.disabled = false;
                videoCallButton.disabled = false;
                
                // Отображаем сообщения
                renderMessages(contact.id);
            }
            
            // Добавление пользователя в контакты
            function addToContacts(user) {
                // Проверяем, не добавлен ли уже пользователь
                if (!contacts.some(contact => contact.id === user.id)) {
                    contacts.push(user);
                    renderContacts();
                    
                    // Показываем уведомление
                    showNotification('message', 'Контакт добавлен', `${user.name} добавлен(а) в ваши контакты`);
                    
                    // Выбираем добавленный контакт
                    selectContact(user);
                }
            }
            
            // Сброс чата
            function resetChat() {
                // Сбрасываем заголовок чата
                document.getElementById('chatUserName').textContent = 'Выберите чат';
                document.getElementById('chatUserAvatar').textContent = 'U';
                document.getElementById('chatUserStatus').textContent = 'начните общение';
                
                // Отключаем поле ввода и кнопки
                messageInput.disabled = true;
                sendMessageButton.disabled = true;
                voiceCallButton.disabled = true;
                videoCallButton.disabled = true;
                
                // Очищаем сообщения
                messagesContainer.innerHTML = `
                    <div style="text-align: center; margin-top: 50px; color: var(--gray-color);">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>Выберите чат для начала общения</p>
                    </div>
                `;
                
                // Снимаем выделение с контактов
                document.querySelectorAll('.contact').forEach(el => {
                    el.classList.remove('active');
                });
                
                currentContact = null;
            }
            
            // Отображение сообщений
            function renderMessages(contactId) {
                const messageList = messages[contactId] || [];
                
                messagesContainer.innerHTML = '';
                
                if (messageList.length === 0) {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; margin-top: 50px; color: var(--gray-color);">
                            <i class="fas fa-comment" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>Начните общение с этим пользователем</p>
                        </div>
                    `;
                    return;
                }
                
                messageList.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `message ${message.outgoing ? 'message-outgoing' : 'message-incoming'}`;
                    
                    messageElement.innerHTML = `
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">${message.time}</div>
                    `;
                    
                    messagesContainer.appendChild(messageElement);
                });
                
                // Прокручиваем вниз к последним сообщениям
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // Отправка сообщения
            function sendMessage() {
                const text = messageInput.value.trim();
                
                if (!text || !currentContact) return;
                
                // Создаем новое сообщение
                const newMessage = {
                    id: Date.now(),
                    text: text,
                    sender: 'current',
                    time: getCurrentTime(),
                    outgoing: true
                };
                
                // Добавляем сообщение в список
                if (!messages[currentContact.id]) {
                    messages[currentContact.id] = [];
                }
                
                messages[currentContact.id].push(newMessage);
                
                // Отображаем сообщение
                renderMessages(currentContact.id);
                
                // Очищаем поле ввода
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                // Имитируем ответ
                setTimeout(() => {
                    // Создаем ответное сообщение
                    const replyMessage = {
                        id: Date.now() + 1,
                        text: getRandomReply(),
                        sender: currentContact.id,
                        time: getCurrentTime(),
                        outgoing: false
                    };
                    
                    // Добавляем ответное сообщение
                    messages[currentContact.id].push(replyMessage);
                    
                    // Обновляем отображение
                    renderMessages(currentContact.id);
                    
                    // Показываем уведомление о новом сообщении
                    showNotification('message', 'Новое сообщение', `${currentContact.name}: ${replyMessage.text.substring(0, 50)}...`);
                }, 1000 + Math.random() * 2000);
            }
            
            // Начать звонок
            function startCall(type) {
                if (!currentContact || callInProgress) return;
                
                currentCallType = type;
                isCaller = true;
                callInProgress = true;
                
                // Настраиваем интерфейс звонка
                callTitle.textContent = type === 'video' ? 'Исходящий видеозвонок' : 'Исходящий аудиозвонок';
                callDescription.textContent = `Звонок пользователю ${currentContact.name}`;
                remoteUserName.textContent = currentContact.name;
                
                // Показываем кнопку завершения звонка
                acceptCallButton.classList.add('hidden');
                declineCallButton.classList.add('hidden');
                endCallButton.classList.remove('hidden');
                
                // Показываем окно звонка
                callContainer.style.display = 'flex';
                
                // Инициализируем медиа
                initializeMedia(type);
                
                // Имитируем входящий звонок для получателя
                setTimeout(() => {
                    if (callInProgress) {
                        // Показываем уведомление о звонке (имитация)
                        showNotification('incoming-call', 
                            type === 'video' ? 'Входящий видеозвонок' : 'Входящий аудиозвонок', 
                            `${currentContact.name} звонит вам`, 
                            [
                                { text: 'Принять', action: 'acceptCall', type: 'success' },
                                { text: 'Отклонить', action: 'declineCall', type: 'danger' }
                            ]
                        );
                    }
                }, 1500);
            }
            
            // Принять звонок
            function acceptCall() {
                // Скрываем уведомление
                hideNotification();
                
                // Обновляем интерфейс звонка
                callTitle.textContent = currentCallType === 'video' ? 'Видеозвонок' : 'Аудиозвонок';
                callDescription.textContent = `Звонок с ${currentContact.name}`;
                
                // Показываем кнопку завершения звонка
                acceptCallButton.classList.add('hidden');
                declineCallButton.classList.add('hidden');
                endCallButton.classList.remove('hidden');
                
                // Инициализируем медиа
                initializeMedia(currentCallType);
            }
            
            // Отклонить звонок
            function declineCall() {
                // Скрываем уведомление
                hideNotification();
                
                // Завершаем звонок
                endCall();
                
                // Показываем уведомление
                showNotification('message', 'Звонок отклонен', 'Вы отклонили входящий звонок');
            }
            
            // Завершить звонок
            function endCall() {
                // Останавливаем все медиапотоки
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                
                // Сбрасываем переменные
                peerConnection = null;
                localStream = null;
                remoteStream = null;
                callInProgress = false;
                isCaller = false;
                
                // Скрываем окно звонка
                callContainer.style.display = 'none';
                
                // Очищаем видеоэлементы
                localVideo.srcObject = null;
                remoteVideo.srcObject = null;
                
                // Показываем уведомление
                showNotification('message', 'Звонок завершен', 'Соединение разорвано');
            }
            
            // Включить/выключить видео
            function toggleVideo() {
                if (!localStream) return;
                
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    isVideoEnabled = !videoTrack.enabled;
                    videoTrack.enabled = isVideoEnabled;
                    
                    // Обновляем иконку кнопки
                    const icon = toggleVideoButton.querySelector('i');
                    icon.className = isVideoEnabled ? 'fas fa-video' : 'fas fa-video-slash';
                    
                    // Обновляем состояние кнопки
                    if (isVideoEnabled) {
                        toggleVideoButton.classList.remove('btn-danger');
                        toggleVideoButton.classList.add('btn-success');
                    } else {
                        toggleVideoButton.classList.remove('btn-success');
                        toggleVideoButton.classList.add('btn-danger');
                    }
                }
            }
            
            // Включить/выключить микрофон
            function toggleAudio() {
                if (!localStream) return;
                
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    isAudioEnabled = !audioTrack.enabled;
                    audioTrack.enabled = isAudioEnabled;
                    
                    // Обновляем иконку кнопки
                    const icon = toggleAudioButton.querySelector('i');
                    icon.className = isAudioEnabled ? 'fas fa-microphone' : 'fas fa-microphone-slash';
                    
                    // Обновляем состояние кнопки
                    if (isAudioEnabled) {
                        toggleAudioButton.classList.remove('btn-danger');
                        toggleAudioButton.classList.add('btn-success');
                    } else {
                        toggleAudioButton.classList.remove('btn-success');
                        toggleAudioButton.classList.add('btn-danger');
                    }
                }
            }
            
            // Инициализация медиа
            async function initializeMedia(type) {
                try {
                    // Получаем медиапоток
                    const constraints = {
                        audio: true,
                        video: type === 'video' ? true : false
                    };
                    
                    localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // Отображаем локальное видео
                    localVideo.srcObject = localStream;
                    
                    // Имитируем удаленный поток (в реальном приложении это был бы WebRTC)
                    setTimeout(() => {
                        // В реальном приложении здесь было бы установление WebRTC соединения
                        // Для демонстрации имитируем удаленный поток
                        simulateRemoteStream();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Ошибка доступа к медиаустройствам:', error);
                    showNotification('message', 'Ошибка доступа', 'Не удалось получить доступ к камере или микрофону');
                }
            }
            
            // Имитация удаленного видеопотока
            function simulateRemoteStream() {
                // В реальном приложении здесь был бы WebRTC
                // Для демонстрации создаем тестовый поток
                const canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 480;
                const ctx = canvas.getContext('2d');
                
                // Создаем анимацию для тестового видео
                function drawFrame() {
                    if (!callInProgress) return;
                    
                    // Очищаем canvas
                    ctx.fillStyle = '#333';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Рисуем текст
                    ctx.fillStyle = '#fff';
                    ctx.font = '30px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(currentContact.name, canvas.width / 2, canvas.height / 2);
                    
                    // Рисуем круг
                    ctx.beginPath();
                    ctx.arc(canvas.width / 2, canvas.height / 2 + 50, 40, 0, Math.PI * 2);
                    ctx.strokeStyle = '#4361ee';
                    ctx.lineWidth = 5;
                    ctx.stroke();
                    
                    // Создаем поток из canvas
                    canvas.captureStream(25).getTracks().forEach(track => {
                        if (!remoteStream) {
                            remoteStream = new MediaStream();
                        }
                        remoteStream.addTrack(track);
                    });
                    
                    // Отображаем удаленное видео
                    remoteVideo.srcObject = remoteStream;
                    
                    // Запрашиваем следующий кадр
                    requestAnimationFrame(drawFrame);
                }
                
                drawFrame();
            }
            
            // Загрузка доступных медиаустройств
            async function loadMediaDevices() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    
                    cameras = devices.filter(device => device.kind === 'videoinput');
                    microphones = devices.filter(device => device.kind === 'audioinput');
                    
                    // Заполняем выпадающие списки
                    cameras.forEach(camera => {
                        const option = document.createElement('option');
                        option.value = camera.deviceId;
                        option.text = camera.label || `Камера ${cameraSelect.options.length + 1}`;
                        cameraSelect.appendChild(option);
                    });
                    
                    microphones.forEach(microphone => {
                        const option = document.createElement('option');
                        option.value = microphone.deviceId;
                        option.text = microphone.label || `Микрофон ${microphoneSelect.options.length + 1}`;
                        microphoneSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Ошибка загрузки медиаустройств:', error);
                }
            }
            
            // Смена камеры
            async function changeCamera() {
                if (!localStream || !callInProgress) return;
                
                const deviceId = cameraSelect.value;
                const constraints = {
                    video: { deviceId: { exact: deviceId } },
                    audio: isAudioEnabled
                };
                
                try {
                    // Получаем новый поток с выбранной камерой
                    const newStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // Заменяем видеодорожку
                    const videoTrack = newStream.getVideoTracks()[0];
                    const oldVideoTrack = localStream.getVideoTracks()[0];
                    
                    if (oldVideoTrack) {
                        oldVideoTrack.stop();
                        localStream.removeTrack(oldVideoTrack);
                    }
                    
                    localStream.addTrack(videoTrack);
                    localVideo.srcObject = localStream;
                    
                } catch (error) {
                    console.error('Ошибка смены камеры:', error);
                }
            }
            
            // Смена микрофона
            async function changeMicrophone() {
                if (!localStream || !callInProgress) return;
                
                const deviceId = microphoneSelect.value;
                const constraints = {
                    video: isVideoEnabled,
                    audio: { deviceId: { exact: deviceId } }
                };
                
                try {
                    // Получаем новый поток с выбранным микрофоном
                    const newStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // Заменяем аудиодорожку
                    const audioTrack = newStream.getAudioTracks()[0];
                    const oldAudioTrack = localStream.getAudioTracks()[0];
                    
                    if (oldAudioTrack) {
                        oldAudioTrack.stop();
                        localStream.removeTrack(oldAudioTrack);
                    }
                    
                    localStream.addTrack(audioTrack);
                    
                } catch (error) {
                    console.error('Ошибка смены микрофона:', error);
                }
            }
            
            // Показать уведомление
            function showNotification(type, title, text, actions = []) {
                notification.className = `notification ${type}`;
                notificationTitle.textContent = title;
                notificationText.textContent = text;
                
                // Устанавливаем иконку
                const icon = notification.querySelector('.notification-icon i');
                if (type === 'incoming-call') {
                    icon.className = 'fas fa-phone';
                } else {
                    icon.className = 'fas fa-bell';
                }
                
                // Добавляем действия
                notificationActions.innerHTML = '';
                actions.forEach(action => {
                    const button = document.createElement('button');
                    button.className = `btn btn-small btn-${action.type}`;
                    button.textContent = action.text;
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        window[action.action]();
                    });
                    notificationActions.appendChild(button);
                });
                
                // Показываем уведомление
                notification.classList.add('show');
                
                // Автоматически скрываем через 10 секунд (кроме звонков)
                if (type !== 'incoming-call') {
                    setTimeout(() => {
                        hideNotification();
                    }, 10000);
                }
            }
            
            // Скрыть уведомление
            function hideNotification() {
                notification.classList.remove('show');
            }
            
            // Показать ошибку
            function showError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
            
            // Получить текущее время
            function getCurrentTime() {
                const now = new Date();
                return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            }
            
            // Получить случайный ответ
            function getRandomReply() {
                const replies = [
                    "Привет! Как дела?",
                    "Отлично, спасибо!",
                    "Что нового?",
                    "Давай созвонимся позже",
                    "Я как раз об этом думал",
                    "Интересно, расскажи подробнее",
                    "Согласен с тобой",
                    "Спасибо за информацию!",
                    "У меня все хорошо",
                    "Давай встретимся на неделе"
                ];
                
                return replies[Math.floor(Math.random() * replies.length)];
            }
        });
    </script>
</body>
</html>
